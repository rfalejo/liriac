# L-03 â€” StopPolicy VO (Developer Guide)

Purpose: implement an immutable StopPolicy value object that validates a bounded set of stop sequences used to terminate AI generation. Keep it simple, dependency-free, and aligned with the domain error model.

## Outcomes
- A StopPolicy VO with shape: sequences as an immutable ordered collection.
- Validation ensuring sequences are well-formed, bounded in size/length, and non-empty.
- Clear, actionable error messages using the domain exception hierarchy.
- Tests covering valid/invalid cases, ordering, value semantics, and representation.

## Scope
- Implement a StopPolicy VO in the domain layer, with the public API kept minimal and explicit.
- Represent sequences as an immutable tuple of strings to communicate value semantics.
- Provide a constructor/factory that performs all validation and normalization.
- Avoid any IO, provider SDK types, or external libraries.

## Public API
- StopPolicy: immutable VO with sequences: tuple[str, ...].
- Construction: factory or dataclass constructor that validates inputs.
- Helpers (optional but recommended):
  - normalize: trim and validate each sequence; collapse duplicates optionally.
  - from_iterable: accept any iterable of strings and return StopPolicy.
- Re-export from liriac.domain for clean imports.

## Invariants and Validation Rules
- Non-empty policy: at least one sequence is required.
- Non-empty items: each sequence must be non-empty after trimming.
- Whitespace policy: trimming allowed; reject if empty post-trim.
- Length bounds: each sequence should be reasonably short; pick a pragmatic upper bound (for example, 128 characters). Include the offending length in error messages.
- Count bounds: cap the number of sequences (for example, maximum 8). Include the provided count in error messages.
- Type safety: sequences must be str; reject non-string types with a concise message.
- Duplicates: preserve input order. If deduplication is chosen, preserve first occurrence and drop later duplicates deterministically; document behavior. It is acceptable to retain duplicates for MVP; if retained, explicitly allow duplicates and rely on adapters if needed later.

## Errors
- Use InvariantViolation for any invalid input.
- Message guidance:
  - Empty policy: "StopPolicy must include at least one sequence".
  - Empty item: "Stop sequence cannot be empty".
  - Too long: "Stop sequence exceeds maximum length 128 (got N)".
  - Too many: "StopPolicy allows at most 8 sequences (got N)".
  - Wrong type: "Stop sequence must be a string (got type T)".

## Representation and Equality
- Immutability: prefer a frozen dataclass with sequences: tuple[str, ...], or a small class wrapping a tuple with read-only property.
- Equality: value-based equality via tuple contents and order.
- Hashability: make instances hashable by virtue of immutability; do not include transient fields.

## Module Layout and Exports
- Location: liriac/domain/stop_policy.py (small, focused module).
- No imports from adapters or other domain modules; only import domain errors and typing.
- Add __all__ to control the public surface.
- Re-export in liriac/domain/__init__.py alongside other VOs.

## Normalization Rules
- Trim each sequence using standard whitespace trimming.
- Reject a sequence if it becomes empty after trim.
- Do not automatically coerce to lowercase or otherwise change content.
- If deduplicating, keep the first occurrence and drop later duplicates while preserving the original order of the retained items.

## Design Choices
- Tuples vs dataclass: a frozen dataclass improves discoverability and docstrings while keeping memory overhead minimal; tuple storage remains the internal representation.
- Bounds: pick conservative, easy-to-explain defaults (item length 1..128, count 1..8). These can be adjusted later if needs arise.
- Zero-cost at runtime: avoid complex regex; simple checks suffice.

## Testing Strategy
- Location: tests/domain/test_stop_policy.py.
- Valid cases:
  - Single sequence like "\n\n".
  - Multiple sequences with different lengths and characters.
  - Trimming: "  END  " becomes "END".
  - Boundary lengths: 1 and 128 characters pass.
  - Boundary count: 8 items pass.
- Invalid cases:
  - Empty list.
  - Any empty or whitespace-only item.
  - Non-string items (e.g., None, 123).
  - Item length 0 or > 128.
  - Count > 8.
- Order and equality:
  - Preserve order of input sequences after normalization.
  - Two policies with identical ordered sequences compare equal.
- Optional deduplication (if implemented):
  - Input with duplicates results in first occurrence kept; equality reflects deduped tuples.
- Error messages:
  - Assert messages contain the critical guidance and offending values (counts/lengths).

## Implementation Steps
1) Create liriac/domain/stop_policy.py with a frozen dataclass or small class wrapping a tuple[str, ...].
2) Implement a constructor/factory that:
   - Accepts Iterable[str] or list[str].
   - Normalizes via trimming, validates types, and enforces bounds.
   - Optionally deduplicates while preserving order.
   - Stores sequences as a tuple.
3) Raise InvariantViolation with concise, actionable messages on any invalid input.
4) Add __all__ to the module to export StopPolicy.
5) Re-export StopPolicy from liriac/domain/__init__.py.
6) Write tests under tests/domain/test_stop_policy.py covering valid/invalid paths, order, equality, and messages.
7) Run pytest and iterate until all tests pass.

## Message Quality Guidelines
- Include numeric bounds in errors to aid debugging.
- Avoid provider-specific or adapter details.
- Keep messages single-sentence and direct.

## Performance and Memory
- Keep only the tuple of sequences; avoid storing duplicates of the same data.
- No heavy normalization beyond trimming.
- __slots__ is optional; frozen dataclass plus tuple is typically sufficient.

## Future Considerations
- Model/provider-specific constraints can be validated in adapters, not in domain.
- Allow per-book defaults managed by configuration outside the VO.
- If we expand bounds, maintain backward compatibility and document changes.

## Acceptance Criteria
- StopPolicy is importable from liriac.domain with sequences as an immutable tuple.
- Constructor/factory enforces the documented invariants and raises InvariantViolation with helpful messages.
- Unit tests cover boundaries, invalid cases, and value equality.
- No external dependencies; module is independent of adapters and services.

## Documentation Notes
- Add a succinct class docstring explaining the purpose, invariants, and typical usage sites (e.g., chapter append operations).
- Reference this ticket from the domain design index if maintained.
