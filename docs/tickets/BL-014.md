# Ticket BL-014: TUI Suggestions Mode — Prompt, Streaming, Accept/Regenerate/Cancel

## Description
Integrate the Suggestions service into the Editor to provide an end-to-end “Suggest Mode” in the TUI. The user can open a prompt panel from the editor, enter a prompt, stream AI deltas live, accept or regenerate suggestions, and cancel streaming. Accepting a suggestion merges it into the editor text and writes a Markdown log entry under `.liriac/suggestions/` using the existing services. No real network calls are required in tests; inject a fake provider for deterministic streaming.

This ticket adds a small Suggest UI component (modal/panel) and wires it into the Editor’s key bindings. Business logic remains in the Services layer; the TUI only orchestrates prompt input, streaming display, and actions.

## Acceptance Criteria
- Source layout and structure:
  - `src/liriac/tui/screens/suggest/view.py`:
    - Implements `class SuggestScreen(Screen)` (or a modal-like screen/panel):
      - Constructor args:
        - `library_path: Path`
        - `repo: ChapterRepository` (not used directly for streaming but available if needed)
        - `provider: AIProvider` (injected; tests provide a fake)
        - `ref: ChapterRef`
        - Optional `initial_prompt: str = ""`
      - UI:
        - Bottom prompt input with a concise label.
        - Output area showing live streamed deltas (append-only buffer).
        - Status line showing: “Generating… <n_deltas> [Esc x2] Cancel | [a] Accept | [r] Regenerate”.
      - Behavior:
        - Pressing Enter starts streaming via `SuggestionsService.generate(...)`.
        - While streaming, deltas append to output; Enter is disabled to avoid duplicate starts.
        - `a` (Accept): calls `SuggestionsService.accept(...)` with current editor text, merges returned text back to the Editor (via a callback or message), and closes the suggest screen. This writes the `.liriac/suggestions/*.md` log atomically.
        - `r` (Regenerate): cancels any active stream if needed, clears output, and starts a new `generate(...)` cycle (history length increases).
        - `escape`: if streaming, the first press cancels the stream; a second `escape` closes the suggest screen without merging.
        - Tolerates empty prompt by refusing to start streaming (show a concise inline message).
      - Messages/Integration:
        - Define a message `SuggestionAccepted(merged_text: str)` or invoke a provided callback so the Editor can update its TextArea and dirty state. Keep this message strictly typed.
        - The screen persists no file content directly; accept path uses `SuggestionsService` to write the log entry.
      - Fully annotated; no implicit `Any`.
  - `src/liriac/tui/screens/editor/view.py` (integration):
    - Add key binding `shift+tab` to open `SuggestScreen`.
    - On accept message from SuggestScreen, update the TextArea with the merged text:
      - Set editor dirty state to True (content changed).
      - Optional: schedule autosave via `AutosaveScheduler` if already available in the editor context; if not, keep it out-of-scope for this ticket.
    - No network calls in editor; provider is injected into SuggestScreen.
  - `src/liriac/services/suggestions/__init__.py` remains the public surface; no behavior changes required.
  - `src/liriac/tui/__init__.py`:
    - Re-export `SuggestScreen` and `SuggestionAccepted` if applicable.
- Behavior:
  - Works with `FakeAIProvider` in tests to stream deterministic deltas.
  - Live streaming updates the output area incrementally.
  - Accept merges into the editor text using `merge_text(...)` via the service and logs under `<book>/.liriac/suggestions/` with trailing newline.
  - Regenerate clears the current buffer and starts a new stream; history length increases.
  - Cancel stops streaming promptly and returns to the editor without changes.
  - No disk writes other than the suggestions log on accept.
- Key bindings:
  - In editor: `shift+tab` opens SuggestScreen.
  - In suggest UI:
    - `enter`: start streaming when idle.
    - `a`: accept current suggestion (only when a suggestion exists).
    - `r`: regenerate (only when idle or after a finished stream).
    - `escape`: cancel current stream; pressing again closes the panel if already idle.
- Styling and UX:
  - Minimal visuals; rely on existing defaults.
  - Status line indicates state and available keys.
- Packaging and Dependencies:
  - No new runtime dependencies.
- Typing and Style:
  - `mypy --strict` passes.
  - `ruff` and `black` pass with no changes after formatting.

## Testing Strategy
- TUI tests (Textual Pilot): `tests/tui/test_suggest.py`
  - Fixtures:
    - Temp library with one book/chapter (as in other TUI tests).
    - A `FakeAIProvider` implementing `AIProvider` that yields deterministic deltas, e.g., “Hello ” + “world!” then done.
  - Import tests:
    - `from liriac.tui.screens.suggest.view import SuggestScreen` imports.
  - Open and prompt:
    - Launch `LiriacApp(tmp_library)`; push `EditorScreen`.
    - Press `shift+tab` to open `SuggestScreen`.
    - Type a short prompt and press Enter; assert deltas appear in the output area.
  - Accept:
    - After streaming completes, press `a` to accept.
    - Assert editor’s TextArea now contains merged content (exactly one blank line separation; trailing newline).
    - Assert a log file exists under `<book>/.liriac/suggestions/` with correct filename format and newline at EOF.
  - Regenerate:
    - After first suggestion, press `r` to regenerate; assert a new streaming cycle occurs and does not crash; history length conceptually increases (can be validated by inspecting service history via a hook or observable).
  - Cancel:
    - Start streaming, press `escape` to cancel; assert streaming ends promptly and the UI remains responsive.
    - Press `escape` again to close the SuggestScreen; editor content remains unchanged.
  - Keyboard and stability:
    - Ensure Enter is ignored while streaming to prevent duplicate requests.
    - Ensure no crashes when prompt is empty (show inline message or disable start).
- Quality gates:
  - `make fmt`, `make lint`, `make typecheck`, and `make test` all pass with the new screen and tests.
