# BL-004 — Backend Domain Models

Status: Planned  
Priority: High  
Owner: TBC  
Created: 2025-09-17  
Depends on: BL-001–003 (repo/tooling), BL-009 (schema, optional)

## Summary
Introduce the foundational backend models for the MVP: Book, Chapter, Persona, ContextProfile, Suggestion, SuggestionEvent, and ChapterVersion. These provide the data structures required for autosave, context management, and suggestions streaming in later tickets.

## Goals
- Define models, fields, relationships, and constraints.
- Create initial migrations for new apps.
- Ensure strict typing, validations, and helpful admin/readability defaults.
- Add unit tests for model validators and constraints; smoke-test migrations.

## Non-Goals
- REST endpoints, serializers, viewsets (BL-005 and others).
- Autosave service logic (BL-006).
- Suggestions provider/streaming (BL-007/BL-008).
- Frontend integration.

## App Layout
- `apps.library`: `Book`, `Chapter`, `Persona`, `ContextProfile`
- `apps.suggestions`: `Suggestion`, `SuggestionEvent`
- `apps.autosave`: `ChapterVersion`

Note: If desired, `ChapterVersion` can live under `apps.library`; for separation of concerns, place it in `apps.autosave`.

## Models and Fields

### Book (apps.library)
- `id`: AutoField (PK)
- `title`: CharField(200), not blank
- `slug`: SlugField(200), unique, normalized
- `created_at`: DateTimeField(auto_now_add=True)
- `last_opened`: DateTimeField(null=True, blank=True, db_index=True)

Constraints/Indexes:
- Unique(`slug`)
- Index on `last_opened`
- Default ordering: `["title", "created_at"]`

Validation:
- `slug` required; normalized on save (slugify) or enforced via form/serializer in BL-005.

### Chapter (apps.library)
- `id`: AutoField (PK)
- `book`: ForeignKey(Book, on_delete=CASCADE, related_name="chapters")
- `title`: CharField(200), not blank
- `order`: PositiveIntegerField(db_index=True)  // list order within a book
- `body`: TextField(default="", blank=True)
- `checksum`: CharField(64)  // hex SHA-256 of `body`
- `created_at`: DateTimeField(auto_now_add=True)
- `updated_at`: DateTimeField(auto_now=True)

Constraints/Indexes:
- Unique(book, order)
- Index(book, order)

Validation:
- `checksum` must match `^[0-9a-f]{64}$` (RegexValidator); computed/updated by services in BL-006.

### Persona (apps.library)
- `id`: AutoField (PK)
- `name`: CharField(100), unique
- `role`: CharField(50), blank=True  // e.g., protagonist, antagonist, narrator
- `notes`: TextField(blank=True, default="")
- `created_at`: DateTimeField(auto_now_add=True)

Constraints/Indexes:
- Unique(`name`)
- Default ordering: `["name"]`

### ContextProfile (apps.library)
Represents per-chapter context configuration.

- `id`: AutoField (PK)
- `chapter`: OneToOneField(Chapter, on_delete=CASCADE, related_name="context_profile")
- `personas`: ManyToManyField(Persona, through="ContextProfilePersona", related_name="context_profiles", blank=True)
- `included_chapters`: ManyToManyField(Chapter, related_name="context_in_profiles", symmetrical=False, blank=True)
- `tokens_estimated`: PositiveIntegerField(default=0)
- `token_limit`: PositiveIntegerField(default=8000)

Through model (enabled flag per chapter-persona association):
- `ContextProfilePersona`:
  - `id`: AutoField (PK)
  - `context_profile`: ForeignKey(ContextProfile, on_delete=CASCADE, related_name="persona_links")
  - `persona`: ForeignKey(Persona, on_delete=CASCADE, related_name="context_links")
  - `enabled`: BooleanField(default=True)
  - Unique(context_profile, persona)

Constraints/Indexes:
- Unique one-to-one on `chapter`
- Unique(context_profile, persona) for through model

### Suggestion (apps.suggestions)
- `id`: AutoField (PK)
- `chapter`: ForeignKey(Chapter, on_delete=CASCADE, related_name="suggestions")
- `session_id`: UUIDField(unique=True, db_index=True)
- `status`: CharField(16, choices=[pending, accepted, rejected], default="pending")
- `payload`: JSONField(default=dict, blank=True)  // optional aggregate delta log
- `created_at`: DateTimeField(auto_now_add=True)
- `updated_at`: DateTimeField(auto_now=True)

Constraints/Indexes:
- Unique(`session_id`)
- Index on (`chapter`, `created_at`)
- Default ordering: `["-created_at"]`

### SuggestionEvent (apps.suggestions)
Audit log of suggestion stream events.

- `id`: AutoField (PK)
- `suggestion`: ForeignKey(Suggestion, on_delete=CASCADE, related_name="events")
- `event_type`: CharField(16, choices=[delta, usage, done, error])
- `payload`: JSONField()  // message, token counts, etc.
- `created_at`: DateTimeField(auto_now_add=True, db_index=True)

Constraints/Indexes:
- Index(`suggestion`, `created_at`)
- Default ordering: `["created_at"]`

### ChapterVersion (apps.autosave)
Snapshot of chapter content for autosave/history.

- `id`: AutoField (PK)
- `chapter`: ForeignKey(Chapter, on_delete=CASCADE, related_name="versions")
- `body`: TextField()
- `checksum`: CharField(64)  // hex SHA-256
- `diff_size`: PositiveIntegerField()  // number of changed characters
- `created_at`: DateTimeField(auto_now_add=True, db_index=True)

Constraints/Indexes:
- Index(`chapter`, `created_at`)
- Default ordering: `["-created_at"]`

Validation:
- `checksum` regex and length as per Chapter.

## Admin & String Representations
- Implement `__str__` for all models:
  - Book: `f"{title}"`
  - Chapter: `f"{book.slug}#{order} — {title}"`
  - Persona: `name`
  - Suggestion: `f"{session_id} ({status})"`
  - SuggestionEvent: `f"{suggestion_id}:{event_type}@{created_at:%H:%M:%S}"`
  - ChapterVersion: `f"{chapter_id}@{created_at:%Y-%m-%d %H:%M:%S}"`
- Optional: minimal `ModelAdmin` registration to aid local debugging.

## Migrations
- Create initial migrations for `apps.library`, `apps.suggestions`, and `apps.autosave`.
- Ensure migration order and dependencies are correct (suggestions/autosave depend on `apps.library`).
- No data migrations required; optional: auto-create `ContextProfile` on `Chapter` creation in a later ticket (service or signal).

## Tests (pytest + Django)
Location: `backend/tests/` (see pyproject config).

Unit tests (examples):
- Book
  - Creating two books with same slug fails (IntegrityError).
  - `last_opened` writes and can be ordered.
- Chapter
  - Unique constraint `(book, order)` enforced.
  - `checksum` validator rejects non-hex or wrong length.
  - `updated_at` changes on save.
- Persona
  - Name uniqueness enforced.
- ContextProfile
  - One-to-one with Chapter enforced.
  - M2M personas: through model uniqueness and `enabled` default True.
  - `included_chapters` allows multiple links including self-exclusion (no symmetry).
- Suggestion
  - `session_id` uniqueness enforced.
  - Status choices restricted to [pending, accepted, rejected].
- SuggestionEvent
  - Appending events preserves chronological ordering.
- ChapterVersion
  - `diff_size` must be >= 0.
  - `checksum` validation.

Migration smoke tests:
- Migrate up/down (transactional) without error.
- Create and query minimal records of each model.

Typing:
- Run `mypy --strict` with `django-stubs` installed; no `Any` leaks in models’ public APIs.

## Acceptance Criteria
- Models compiled and registered inside their respective apps with `INSTALLED_APPS` updated.
- All specified fields, choices, relationships, and constraints exist.
- Initial migrations created and apply cleanly on SQLite.
- Unit tests for validators and constraints pass.
- Formatting (ruff/black) and typing (mypy --strict) pass cleanly.
- Optional admin registration and `__str__` methods implemented.

## Implementation Steps (Checklist)
- [ ] Scaffold apps: `apps.library`, `apps.suggestions`, `apps.autosave`.
- [ ] Implement models as specified (fields, choices, relationships).
- [ ] Add `__str__` and Meta (`ordering`, indexes, constraints).
- [ ] Create initial migrations for all apps.
- [ ] Register in `INSTALLED_APPS` (settings).
- [ ] Write unit tests for constraints/validators and basic behaviors.
- [ ] Run `make fmt` and `make lint`.
- [ ] Run `make typecheck` (backend).
- [ ] Run `make test` and confirm green.
- [ ] Document any deviations or decisions in this ticket.

## Open Questions
- Should `Persona.name` be unique globally or per-book? For MVP, keep global unique; revisit with multi-tenant/books features.
Answer: per-book uniqueness adds complexity; global unique is simpler for MVP.
- Keep `Suggestion.status` to three states (pending/accepted/rejected) or add `cancelled`? MVP keeps three; cancellation modeled as a terminal event on the stream (BL-008).
Answer: simpler state machine for MVP; can extend later if needed.
- Should `ContextProfilePersona.enabled` exist or is presence sufficient? MVP includes `enabled` to allow soft toggling without removing links.
Answer: enabled flag provides flexibility for users to manage context without losing associations.

## Notes
- Checksum computation happens in services (BL-006) to keep models thin; models only validate format when provided.
- Token estimate fields on `ContextProfile` are hints; they can be recalculated on demand by services.

## References
- docs/00-draft.md — Data Model Highlights
- docs/01-technical-spec-en.md — Backend Architecture Details
- docs/02-backlog.md — BL-004 Acceptance and model list
