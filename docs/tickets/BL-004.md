# Ticket BL-004: Filesystem Repository for Books and Chapters

## Description
Introduce the first storage adapter to load and persist books and chapters from the user’s filesystem, according to the technical spec’s directory layout. Define typed repository Protocols in the Domain layer and implement a concrete filesystem adapter under Infra. Operations must be strictly typed, perform no network IO, and use safe, atomic writes for chapter content. This ticket focuses on:
- Discovering books under a selected `library_path`.
- Reading `book.toml` metadata and constructing `Book` entities with `ChapterRef` collections.
- Reading chapter files and constructing `Chapter` entities.
- Writing chapter files atomically.
- Ensuring `.liriac/` structure is present (created lazily as needed) without performing unrelated writes.

Out of scope:
- AI providers, suggestions logging, autosave, and versions snapshotting (covered in later tickets).
- Personas persistence (keep `personas` empty for now).
- Any network or blocking UI calls.

## Acceptance Criteria
- Domain Ports:
  - `src/liriac/domain/ports.py` defines `Protocol`s:
    - `LibraryRepository`:
      - `list_books(library_path: Path) -> tuple[BookId, ...]`
      - `load_book(library_path: Path, book_id: BookId) -> Book`
    - `ChapterRepository`:
      - `read_chapter(library_path: Path, ref: ChapterRef) -> Chapter`
      - `write_chapter(library_path: Path, chapter: Chapter) -> None`
  - Docstrings clarify invariants and error behavior. No IO is performed in Domain; only type contracts.

- Infra Implementation (Filesystem):
  - `src/liriac/infra/fs/library.py` implements `FilesystemLibraryRepository(LibraryRepository, ChapterRepository)`.
  - Behavior and rules:
    - Book layout: `<library_path>/<book-slug>/book.toml` and `<library_path>/<book-slug>/chapters/*.md`.
    - Book ID is the `<book-slug>` directory name. `book.toml` must include:
      - `title: str`
      - `created_at: str` (RFC 3339 / ISO 8601 with timezone; if naive, treat as UTC)
      - `chapters: list[str]` (relative POSIX paths, e.g., `"chapters/01.md"`)
      - Optional keys may be ignored.
    - `list_books`: returns slugs of directories containing a readable `book.toml`.
    - `load_book`:
      - Parses `book.toml`; builds `Book(id, title, created_at, chapters=tuple[ChapterRef,...], personas=())`.
      - Validates chapter paths are relative POSIX; converts to `PurePosixPath`.
      - Raises `FileNotFoundError` or `ValueError` with concise messages on missing/invalid metadata.
    - `read_chapter`:
      - Resolves `ref` under its `<book-slug>` directory; reads text.
      - Sets `title` as the filename stem by default (no heading parsing).
      - Sets `updated_at` from file `stat().st_mtime` in UTC (timezone-aware).
      - Raises `FileNotFoundError` with a clear message if not found.
    - `write_chapter`:
      - Writes `chapter.text` atomically into the resolved path under the book directory:
        - Ensure parent dir exists.
        - Write to a temporary file in the same directory and `os.replace()` to the final path.
        - Ensure UTF-8 with `\n` line endings and a trailing newline.
      - Does not mutate the passed entity; returns `None`.
    - Helper: ensure `.liriac/` and subfolders exist lazily when writing (do not create on read paths).
  - No network access; use only `pathlib`, `os`, `io`, `tomllib` (read) and `tomli_w` (write if needed later; not required for this ticket unless extending to write `book.toml`).

- Packaging:
  - `pyproject.toml`:
    - Add runtime dependency: `tomli-w>=1.0.0` (for future metadata writes; optional use is acceptable).
    - Keep strict typing and existing tooling intact.

- Tests:
  - `tests/infra/test_fs_repository.py`:
    - Setup helpers create a temp library with:
      - `library_path / "my-book" / "book.toml"`
      - `library_path / "my-book" / "chapters" / "01.md"`
    - `list_books` returns `("my-book",)`.
    - `load_book` returns a `Book`:
      - `id == BookId("my-book")`
      - `title` equals TOML title; `created_at` timezone-aware
      - `chapters` is `tuple` of `ChapterRef` with relative POSIX paths
      - `personas == ()`
    - `read_chapter` returns a `Chapter`:
      - `id` equals the filename stem as `ChapterId("01")`
      - `title` equals the filename stem `"01"`
      - `text` equals file contents
      - `updated_at` is timezone-aware (`tzinfo is not None`)
    - `write_chapter`:
      - Update chapter text; verify file contents changed and a final newline exists.
      - Verify atomic write strategy by ensuring no `.tmp` files remain and file exists after write.
    - Error handling:
      - Missing `book.toml` → `FileNotFoundError`
      - Invalid `chapters` entries (absolute or with `..`) → `ValueError`
      - Missing chapter file → `FileNotFoundError`
  - All tests avoid network and use `tmp_path`.

- Quality Gates:
  - `make fmt` yields no changes after initial formatting.
  - `make lint` passes cleanly.
  - `make typecheck` passes (`mypy --strict`) with zero errors.
  - `make test` passes and executes new tests.

## Testing Strategy
- Unit tests for Infra (Pytest):
  - Library discovery:
    - Create two book dirs, one with `book.toml`, one without → only the valid slug is listed.
  - Book loading:
    - Write a minimal `book.toml` with ISO 8601 `created_at` and `chapters = ["chapters/01.md"]`.
    - Assert `Book` fields and tuple immutability; invalid TOML values raise `ValueError`.
  - Chapter read:
    - Create `chapters/01.md` with simple content; `read_chapter` returns `Chapter` with UTC `updated_at`.
  - Chapter write (atomic):
    - Call `write_chapter` to update content; re-open file and assert content and trailing newline; no leftover temp files.
  - Errors:
    - Absent `book.toml` and chapter files raise `FileNotFoundError` with concise messages.
    - Absolute or up-level chapter paths in TOML raise `ValueError`.

- Typing and Style:
  - Annotate all functions and variables; no implicit `Any`.
  - Use `PurePosixPath` for chapter paths in value objects; convert from TOML strings safely.
  - Keep raise messages concise and assertable in tests.

- Future-proofing (not executed here):
  - Keep `FilesystemLibraryRepository` methods small and composable for later extension (personas, suggestions, versions).
  - Leave `write_book_metadata` out for now; adding it later will use `tomli_w`.