# Ticket BL-013: UI State Persistence — `.liriac/state.json` (Last Opened)

## Description
Persist minimal, local UI state so the app can remember the last opened chapter per book. Implement a small, typed adapter under Infra (filesystem) that reads/writes a JSON `state.json` file located at `<library>/<book-id>/.liriac/state.json` using atomic writes. The state records the last opened chapter’s relative POSIX path and optional caret position. Integrate lightly with the TUI: when a chapter is selected from Home, persist the state; when chapters of a book are loaded, pre-select/highlight the last opened chapter if present. No network calls; no external dependencies.

## Acceptance Criteria
- Infra — UI State Adapter:
  - `src/liriac/infra/fs/state.py` implements:
    - `@dataclass(frozen=True) class UIState`:
      - `last_opened: str | None` (relative POSIX path like `"chapters/01.md"`)
      - `caret_offset: int | None` (optional, default `None`)
      - `updated_at: str` (UTC ISO 8601)
    - `def load_ui_state(library_path: Path, book_id: BookId) -> UIState`:
      - Reads `<library_path>/<book-id>/.liriac/state.json`; returns defaults if missing.
      - Tolerates invalid/corrupt JSON by returning defaults (no exceptions).
      - Validates and normalizes `last_opened` to a relative string (ignore invalid).
    - `def save_ui_state(library_path: Path, book_id: BookId, state: UIState) -> Path`:
      - Ensures `<book>/.liriac/` exists.
      - Writes JSON atomically using a temp file in the same directory + `os.replace`.
      - UTF-8 with trailing `\n`; returns the final file path.
  - Fully annotated; no implicit `Any`; uses only stdlib (`pathlib`, `json`, `os`, `datetime`, `dataclasses`, `typing`).

- TUI/App Integration:
  - `src/liriac/app.py`:
    - On `ChapterChosen`, call `save_ui_state(...)` with `last_opened` set to the chapter’s relative path and `updated_at` set to current UTC; `caret_offset=None` (for now).
  - `src/liriac/tui/screens/home/view.py`:
    - When loading chapters for a selected book, call `load_ui_state(...)` and, if `last_opened` is present and matches a chapter in the list, pre-highlight/select that chapter item.
  - No additional key bindings; behavior is passive and should not cause crashes when the state file is absent or invalid.

- Packaging and Exposure:
  - No new runtime dependencies.
  - `src/liriac/infra/__init__.py` re-exports `UIState`, `load_ui_state`, `save_ui_state` via `__all__`.

- Quality and Style:
  - Code passes `mypy --strict`.
  - `ruff` and `black` pass after initial format.
  - No network access; only local filesystem reads/writes for the state file.

- Tests:
  - Infra unit tests: `tests/infra/test_ui_state.py`
    - Reading non-existent state returns defaults.
    - Writing creates `<book>/.liriac/state.json` with valid JSON and trailing newline.
    - Atomic write: no `*.tmp` files remain after save; subsequent saves update `updated_at`.
    - Corrupt file content results in defaults (not an exception).
  - TUI integration tests: `tests/tui/test_ui_state_integration.py`
    - After posting `ChapterChosen` for a valid chapter, state file is written with `last_opened` equal to the chapter’s relative path.
    - When reloading chapters for that book, the previously saved `last_opened` chapter is pre-highlighted in the chapters list.
    - All tests run offline on Linux.

## Testing Strategy
- Infra:
  - Build temp library paths and a `<book-id>` with a chapters dir; assert `load_ui_state` on missing file returns `UIState(last_opened=None, caret_offset=None, updated_at=<iso>)`.
  - Save a state and verify file contents parse with `json.loads`, includes keys, and ends with `\n`.
  - Overwrite with a second save; verify `updated_at` changed and no `.tmp` remains.
  - Write an invalid JSON manually and assert `load_ui_state` returns defaults without raising.
- TUI:
  - Use `LiriacApp(tmp_library)` with a book and 1–2 chapters.
  - Post `ChapterChosen` → verify the file exists and contains the expected `last_opened`.
  - Call HomeScreen’s internal chapter load or simulate selecting the book; assert the chapters list highlights the `last_opened` chapter (by filename match).
- Quality gates:
  - `make fmt`, `make lint`, `make typecheck`, and `make test` pass with the new modules and tests.
