# BL-013 — Editor (Text Area, Status Bar, Shortcuts)

Status: Planned  
Owner: Frontend  
Last updated: 2025-09-18  
Epic: Frontend SPA

## Summary
Implement the Editor screen for `/books/:bookId/chapters/:chapterId` with a large, accessible text area, a simple status bar, and baseline keyboard shortcuts. Load chapter content from the API and render it in a controlled component. Do not implement autosave or suggestions yet (handled in BL-014/BL-015). This unblocks subsequent autosave and streaming work.

## Context
- SPA shell and routing exist (BL-011).
- Library dashboard enables navigation to editor routes (BL-012).
- Typed API client and DTOs exist (BL-010).
- Backend endpoints:
  - `GET /api/v1/chapters/{chapterId}/` (loads chapter body/checksum).
- Autosave will land in BL-014; suggestions UI in BL-015. Keep this ticket focused on read/edit UX and minimal scaffolding.

## Scope
- Page assembly:
  - Header with “Editor” and basic breadcrumbs: Book/Chapter IDs or titles when available.
  - Main content: a large, responsive text area (controlled) showing the chapter body.
  - Status bar (footer): shows “Mode: Manual” and a placeholder slot for autosave state.
- Data:
  - Load chapter detail on mount and when the `chapterId` route param changes.
  - Render loading and error states; allow retry.
- UX:
  - Text area fills remaining viewport height under header with sensible padding.
  - Keyboard shortcuts (baseline):
    - `Ctrl/Cmd+S`: prevent default page save and show a non-persistent “Save disabled (BL-014)” hint in the status bar for 2 seconds.
    - `Esc`: blur text area if focused.
  - Manage local state only; no network writes in this ticket.
- Accessibility:
  - Associate `<label>` with the editor control.
  - Ensure status bar uses `role="status"` with polite updates.

Out of scope:
- Autosave logic, checksum, or persistence (BL-014).
- Suggestions drawer or WebSocket streaming (BL-015).
- Context modal and persona selection (later tickets).
- Rich text/Markdown; keep plain text.

## Acceptance Criteria
- Visiting `/books/1/chapters/2` loads chapter detail and displays:
  - Page heading “Editor”.
  - A large, editable text area prefilled with the chapter body.
  - A footer status bar showing “Mode: Manual”.
- Loading state shows a skeleton or spinner in the editor area.
- Error state shows a message and a “Retry” action that re-runs the fetch.
- `Ctrl/Cmd+S` prevents default and shows a temporary hint “Save disabled (BL-014)”.
- `Esc` blurs the text area when focused.
- Navigating to a different `chapterId` updates content without a full page reload.
- TypeScript strict mode passes; Vitest unit tests pass.

## Implementation Plan
1. Data hook:
   - Add `useChapter(chapterId)` wrapping `getChapter(id)` with React Query.
   - Query key: `['chapter', chapterId]`; `staleTime` reasonable (e.g., 30s).
2. Editor UI:
   - Update `src/app/pages/EditorPage.tsx`:
     - Read `bookId` and `chapterId` from params.
     - Use `useChapter` to fetch chapter body/checksum/title.
     - Controlled `<textarea>` with local `value` state initialized from fetched data; sync on chapterId change.
     - Header with “Editor” and a small breadcrumb (bookId/chapterId; title if available).
     - Footer status bar with “Mode: Manual” and transient message area.
3. Shortcuts:
   - Attach keydown handler on the text area (and/or page container):
     - On `Ctrl/Cmd+S`: `event.preventDefault()`; set transient status to “Save disabled (BL-014)” for 2s.
     - On `Esc`: if the text area is focused, blur it.
4. States:
   - Loading: render a skeleton block approximating editor height.
   - Error: show message + “Retry” button that calls `refetch()`.
5. Styling:
   - Use Tailwind utilities for a responsive column; keep to app style.
   - Ensure the editor area is comfortable on desktop and usable on tablet.
6. Tests (Vitest + RTL):
   - Hook tests for `useChapter` (success, error).
   - Page tests:
     - Renders heading and text area with fetched body.
     - Loading and error states; retry calls `refetch`.
     - Shortcut behavior: `Ctrl/Cmd+S` shows transient status; `Esc` blurs.
     - Route change updates editor content.

## Test Plan
- Unit tests:
  - `useChapter` returns data and handles errors via mocked endpoint.
  - `EditorPage`:
    - With mocked `getChapter`, renders loaded body in `<textarea>`.
    - Loading: skeleton present when `isLoading`.
    - Error: message visible; clicking “Retry” calls `refetch`.
    - Keyboard: simulate `Ctrl+S` and assert status text appears then fades; simulate `Esc` and assert `document.activeElement` changes.
    - Param change: rerender with new route; body updates.
- Typecheck:
  - `pnpm run typecheck` passes.
- Lint/format:
  - `pnpm run lint` and `pnpm run format:check` pass.

## Developer Workflow
- Run dev server: `pnpm dev`
- Run tests: `pnpm test`
- Typecheck: `pnpm run typecheck`

## Risks & Mitigations
- State desync on chapter switch:
  - Reset local `value` when `chapterId` changes; guard against flicker during reload.
- Shortcut conflicts:
  - Scope handlers to editor container; always `preventDefault` for `Ctrl/Cmd+S`.
- Future autosave wiring:
  - Keep local state and handlers modular so BL-014 can inject autosave without refactoring.

## Affected Files (planned)
- frontend/src/app/pages/EditorPage.tsx (extend with data + editor UI)
- frontend/src/features/editor/hooks.ts (new: `useChapter`)
- frontend/src/app/__tests__/EditorPage.test.tsx (new)
- frontend/src/features/editor/__tests__/hooks.test.ts (new)
- frontend/src/api/endpoints.ts (reuse `getChapter`)
- frontend/src/api/types.ts (no change unless backend schema evolves)

## Rollback
- Revert changes to `EditorPage`.
- Remove `useChapter` hook and editor tests.

## References
- React Query: https://tanstack.com/query/latest
- Testing Library: https://testing-library.com/docs/react-testing-library/intro
- Tailwind CSS: https://tailwindcss.com/docs
- OpenAPI types: `frontend/src/api/types.ts`
