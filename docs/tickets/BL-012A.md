# BL-012A — Library UX Polish & Dark “CLI” Theme

Status: Planned  
Owner: Frontend  
Last updated: 2025-09-20  
Epic: Frontend SPA

## Summary
Follow-up on BL-012 to refine the Library dashboard UX and introduce a default dark-mode “CLI” aesthetic across the app. Key improvements: ensure the selected book from the `?book=` URL param drives both chapters loading and visible book title without requiring a click, reset chapters pagination when the book changes, improve accessibility semantics for loading and error states, and add a persisted theme toggle (default dark) with minimal styling updates.

## Context
- BL-012 delivered the basic Library dashboard with lists, pagination, and navigation.
- Minor gaps remain for URL-driven selection and pagination reset behavior.
- A cohesive default dark theme improves perceived polish and reduces glare for long writing sessions.

## Scope
- URL-driven selection:
  - Derive the visible selected book title and highlight exclusively from `?book=<id>` when present (even before user clicks).
- Pagination reset:
  - Reset the Chapters panel page to 1 when the selected book changes.
- Accessibility & states:
  - Add `aria-busy` for loading states, clearer retry labels, and consistent focus rings on clickable elements.
- Dark “CLI” default:
  - Default to dark mode on first load (persist choice to localStorage).
  - Add a theme toggle in the header; reflect state by toggling `document.documentElement.classList` (`dark`).
  - Apply dark variants to existing components: surfaces, borders, text, skeletons, hover states.
  - “CLI” aesthetic hints: reduced chrome, high-contrast neutrals (zinc/gray), monospace preference where appropriate (layouts remain clean and minimal).

Out of scope:
- Full visual redesign beyond dark variants.
- New data features (create/edit flows), autosave changes, or WebSocket UI.

## Acceptance Criteria
- Visiting `/` with `?book=<id>`:
  - Chapters panel loads for that book.
  - The book item is visibly selected/highlighted.
  - The Chapters header shows the selected book title without needing a click.
- Changing the selected book resets the Chapters panel to page 1.
- Loading states:
  - List containers expose `aria-busy="true"` while loading.
  - Skeletons render with dark-friendly variants.
- Error states:
  - Retry buttons have accessible labels (e.g., `aria-label="Retry loading books"` or chapters).
- Dark mode:
  - First visit defaults to dark mode if no prior preference saved.
  - Toggling theme updates the root `dark` class and persists to localStorage.
  - Core pages (Library, Editor) use readable contrast and appropriate dark variants for borders/backgrounds/hover.
- Tests:
  - LibraryPage: with `/?book=1`, shows the selected book title in Chapters header and highlights the book.
  - ChaptersList: switching `bookId` resets `currentPage` to 1.
  - Theme: default dark class applied on first render when no stored preference; toggling persists and flips the class.

## Implementation Plan
1. URL-driven selection
   - LibraryPage: when `?book=` is present and books query resolves, compute and set `selectedBook` from results; avoid requiring a click for title/highlight.
2. Chapters pagination reset
   - ChaptersList: add `useEffect` to reset `currentPage` to 1 whenever `bookId` changes.
3. Accessibility & semantics
   - Add `aria-busy` to lists during loads; ensure Retry buttons have meaningful `aria-label`s.
   - Ensure focus-visible rings on interactive elements (buttons).
4. Dark-mode “CLI” theme
   - useTheme: default to `'dark'` when no saved preference (optionally detect `prefers-color-scheme: dark`).
   - AppLayout: add theme toggle in the header; apply dark variants (`dark:bg-zinc-900`, `dark:text-zinc-100`, `dark:border-zinc-800`), optionally `font-mono` where it fits the “CLI” feel.
   - BooksList/ChaptersList/EditorPage: add dark variants for cards, borders, skeletons, and hover states.
   - index.css: ensure base styles don’t force light backgrounds; rely on Tailwind utilities for colors.
5. Tests (Vitest + RTL)
   - LibraryPage.test: assert URL-driven selection shows book title and highlight.
   - ChaptersList.test: assert page reset on `bookId` change.
   - New Theme.test: assert default dark and toggle persistence.

## Test Plan
- Unit/component tests:
  - LibraryPage: URL param selection -> chapters title and item highlight.
  - ChaptersList: pagination resets to 1 on book change.
  - Theme toggle: root `dark` class default and persistence after toggle.
- Typecheck:
  - `pnpm run typecheck` passes.
- Lint/format:
  - `pnpm run lint` and `pnpm run format:check` pass.

## Risks & Mitigations
- Visual regressions in light mode:
  - Keep light classes intact; use additive `dark:` variants; cross-check key views.
- Overfetch due to URL selection logic:
  - Use React Query’s caching; avoid redundant state updates; guard computations.
- A11y regressions:
  - Validate headings, roles, and focus behavior in tests.

## Affected Files (planned)
- frontend/src/hooks/useTheme.ts (default dark, optional system detection)
- frontend/src/app/layouts/AppLayout.tsx (theme toggle + dark classes)
- frontend/src/app/pages/LibraryPage.tsx (URL-driven selected book title/highlight)
- frontend/src/features/library/BooksList.tsx (dark classes, aria-busy, focus styles)
- frontend/src/features/library/ChaptersList.tsx (dark classes, aria-busy, page reset)
- frontend/src/app/pages/EditorPage.tsx (dark classes for editor shell)
- frontend/src/index.css (ensure neutral base compatible with dark)
- Tests:
  - frontend/src/app/__tests__/LibraryPage.test.tsx (URL-driven selection assertions)
  - frontend/src/features/library/__tests__/ChaptersList.test.tsx (pagination reset)
  - frontend/src/app/__tests__/Theme.test.tsx (new; default dark + toggle persistence)

## Rollback
- Remove dark-variant classes and theme toggle, revert `useTheme` default, and revert URL-driven selection and page reset changes in respective components.

## References
- Tailwind dark mode patterns.
- React Query docs for query enabling, caching, and derived state.
- WAI-ARIA Authoring Practices for loading and error state semantics.
