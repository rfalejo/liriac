# L-02 — Value Objects: Identifiers and Basics (Developer Guide)

Purpose: implement core, lightweight value objects (VOs) used pervasively across the domain with pragmatic validation and clear failure modes. Keep them simple, fast, and easy to use in the MVP.

## Outcomes

- A small set of VOs and helpers providing:
  - Consistent identifier formatting and parsing.
  - Clear invariants with precise exceptions.
  - Simple, dependency-free implementations suitable for unit testing.
- Tests verifying happy paths, invalid inputs, and equality/immutability semantics where applicable.

## Scope

- Implement the following VOs and helpers in the domain layer:
  - BookId (string type alias)
  - ChapterId (string, format "ch_XX" zero-padded)
  - Slug (validated string, lowercase-hyphenated)
  - Title (validated string, non-empty, trimmed)
  - Markdown (opaque text wrapper; semantics only)
  - TokenCount (int alias; non-negative guard where used)
  - Timestamp (ISO-8601 string at boundaries; domain treats as opaque string)
- Include minimal constructor/factory functions and format/parse helpers.
- Raise only domain exceptions (no built-in ValueError, etc.).
- No IO, no external libraries, no tokenizer coupling.

## Constraints and Conventions

- Python 3.11+ typing; prefer `typing.NewType` for simple aliases.
- For structured VOs (e.g., Slug), either:
  - Use a small `@dataclass(frozen=True)` with a single `value: str`, or
  - Keep a function-based constructor returning `str` with validation.
- Error model:
  - Bad inputs: raise `InvariantViolation` or `SlugInvalid` as appropriate.
  - Keep messages concise, include sanitized identifiers when helpful.
- Keep the module independent from adapters and other domain modules to avoid cycles.
- Re-export public symbols via `liriac.domain.__init__` when added later.

## Public API (names and responsibilities)

- BookId:
  - Type: `NewType("BookId", str)`
  - Construction: helper `book_id(value: str) -> BookId` (minimal/no extra validation in MVP).
- ChapterId:
  - Type: `NewType("ChapterId", str)`
  - Helpers:
    - `make_chapter_id(number: int) -> ChapterId` (zero-pads to two digits for MVP; consider 3+ later).
    - `parse_chapter_id(value: str) -> tuple[int, ChapterId]` (validate prefix `ch_`, 2-digit integer).
  - Invariants: prefix "ch_", positive integer, zero-padded (e.g., "ch_01").
  - Errors: `InvariantViolation` with brief message containing the offending value.
- Slug:
  - Shape: validated lowercase-hyphenated string.
  - Constructor: `slug(value: str) -> str` (or frozen dataclass `Slug(value: str)`).
  - Validation rules:
    - Allowed chars: `[a-z0-9-]+`
    - No leading/trailing hyphen.
    - No spaces or underscores.
    - At least 1 character, practical upper bound (e.g., 64) optional in MVP.
  - Errors: `SlugInvalid` with guidance like "must be lowercase-hyphenated".
- Title:
  - Constructor: `title(value: str) -> str`
  - Validation rules:
    - Trim input; must be non-empty after trimming.
    - Optional max length (e.g., 200) for MVP; if enforced, include brief message.
  - Errors: `InvariantViolation`.
- Markdown:
  - Wrapper semantics only; may be plain `str` in MVP.
  - Optional helper: `markdown(value: str) -> str` (ensure not `None`, accept empty string).
- TokenCount:
  - Type: `NewType("TokenCount", int)`
  - Helpers: `token_count(value: int) -> TokenCount`
  - Validation: non-negative integer; overflow concerns out of scope.
  - Errors: `InvariantViolation`.
- Timestamp:
  - Type: `NewType("Timestamp", str)`
  - Domain treats as ISO-8601 string; adapters may use datetime.
  - Optional helper to assert a coarse ISO-8601 shape if necessary.

## Validation Rules (details)

- Slug:
  - Regex concept: start/end anchors, only lowercase letters, digits, hyphens.
  - Disallow consecutive hyphens if you choose (optional in MVP).
  - Normalize by trimming input; do not auto-lowercase silently—prefer rejecting to avoid surprising transforms in domain.
- ChapterId:
  - Accept only "ch_" followed by a zero-padded positive integer (two digits in MVP).
  - When parsing, return both number and normalized id to simplify callers.
- Title:
  - Trim whitespace; ensure length > 0.
  - Avoid storing differently than presented; keep domain predictable.
- TokenCount:
  - Ensure type is int and >= 0; raise for negatives.

## Error Mapping

- Use domain errors from `liriac.domain.errors`:
  - Invalid Slug: `SlugInvalid("Slug '...' is invalid: must be lowercase-hyphenated")`
  - Invalid ChapterId: `InvariantViolation("ChapterId '...' must match 'ch_XX'")`
  - Invalid Title: `InvariantViolation("Title cannot be empty")`
  - Invalid TokenCount: `InvariantViolation("Token count cannot be negative")`
- Prefer short, diagnostic messages with the offending value in single quotes.

## Module Layout Options

- Single module: `liriac/domain/values.py` containing all VOs and helpers (recommended for MVP).
- Alternatively, split by concern later as surface grows.
- Ensure `__all__` is defined for discoverability and explicit exports.

## Usage Examples (inline, not full code)

- Creating a ChapterId:
  - Use `make_chapter_id(3)` to get `"ch_03"`.
  - Use `parse_chapter_id("ch_12")` to get `(12, "ch_12")`; raising on invalid inputs.
- Validating a Slug:
  - `slug("my-book")` succeeds.
  - `slug("My Book")` raises `SlugInvalid`.
- Title guard:
  - `title("  Prologue  ")` returns trimmed title.
  - `title("   ")` raises `InvariantViolation`.

## Testing Strategy

- Location: `tests/domain/test_values.py` (new).
- Tests to include:
  - Slug:
    - Valid inputs (e.g., "my-book", "book2"); invalid inputs (uppercase, spaces, trailing hyphen).
    - Assert `SlugInvalid` and message snippets ("slug", "invalid", "lowercase-hyphenated").
  - ChapterId:
    - `make_chapter_id(1)` -> "ch_01"; `make_chapter_id(12)` -> "ch_12".
    - `parse_chapter_id("ch_03")` -> `(3, "ch_03")`.
    - Invalid forms: "ch3", "chapter_03", "ch_-1", "ch_001" (if strictly two digits in MVP).
  - Title:
    - Accept non-empty after trim; reject empty/whitespace-only.
  - TokenCount:
    - Accept 0 and positive ints; reject negative values.
  - Equality/immutability:
    - If any VO is a frozen dataclass, assert value equality and immutability (type and value-based equality).
- Avoid mocking; keep tests pure and deterministic.

## Implementation Notes

- Keep regexes pre-compiled if used frequently; otherwise runtime `re.fullmatch` is fine for MVP.
- Prefer small helpers for normalization/formatting; do not bury logic inside ad-hoc call sites.
- Return normalized forms from helpers (e.g., trimmed title).
- Avoid auto-corrections (e.g., lowercasing slug) in domain; force callers to be explicit.
- Keep functions side-effect free and without global state.

## Documentation and Discoverability

- Add concise docstrings to each helper/VO covering:
  - What it validates.
  - Expected format.
  - Error type on failure.
- Link this ticket doc from a design index if maintained.

## Acceptance Criteria (recap)

- All VOs and helpers exist with documented behavior.
- Errors raised are from the domain hierarchy, with clear messages.
- Unit tests cover valid/invalid cases and pass consistently.
- No external dependencies introduced; module is import-cycle free.

## Future Considerations

- Expand ChapterId padding to 3+ digits; provide migration helper if needed.
- Consider richer Slug normalization (lowercasing) via adapter or an explicit transform function.
- Promote Markdown to a small frozen dataclass if we add semantics (e.g., length, sections).
- Add stricter ISO-8601 validation for Timestamp if/when necessary.
