# L-04 — Entities: Book and Chapter (Developer Guide)

Purpose: implement core domain entities for Book and Chapter with light, explicit invariants. Keep them simple, dependency-free, and aligned with the existing value objects and error model. No IO, adapters, or provider coupling.

## Summary
- Add two mutable dataclasses in the domain: Book and Chapter.
- Enforce invariants at construction and on mutators using existing value helpers.
- Keep the API minimal and predictable; prefer clarity over magic.
- Re-export entities from `liriac.domain` for ergonomic imports.

## Scope
- Implement Book and Chapter dataclasses with well-defined fields and light validation.
- Add minimal mutator methods for title/renumber operations that preserve invariants.
- Provide straightforward string representations for debugging.
- Update `liriac.domain.__init__` to re-export Book and Chapter.
- Add unit tests under `tests/domain/test_entities.py`.

Out of scope:
- Append-only generation and user-edit operations (L-05).
- Context planning, adapters, persistence, or CLI/TUI integration.
- Versioning, events, repositories, or Unit of Work patterns.

## Design Principles
- Domain errors only: raise `InvariantViolation` (and `SlugInvalid` via `slug()`).
- Constructor validation plus small mutators that re-validate inputs.
- Entities are mutable for MVP; value objects remain immutable.
- No cross-module cycles; depend only on `liriac.domain.errors` and `liriac.domain.values`.
- Keep messages concise and diagnostic; include offending values or lengths when helpful.

## Module Layout
- `liriac/domain/book.py` — Book entity (dataclass).
- `liriac/domain/chapter.py` — Chapter entity (dataclass).
- `liriac/domain/__init__.py` — re-export `Book`, `Chapter`.

Rationale: small focused modules mirror existing layout (values, stop_policy) and aid discoverability.

## Public API
Book
- Fields:
  - `id: BookId` — required; validated via `book_id()`.
  - `slug: str` — required; validated via `slug()`.
  - `title: str` — required; validated via `title()`.
  - Optional metadata fields may be added later (genre, audience, tone) but are not required for L-04.
- Invariants:
  - `id` is non-empty after trim.
  - `slug` is lowercase-hyphenated and within length bounds.
  - `title` is non-empty after trim and within length bounds.
- Mutators:
  - `retitle(new_title: str) -> None` — validates with `title()` and assigns normalized result.
  - Optional `reslug(new_slug: str) -> None` — validates via `slug()`; only if useful now.
- Representation:
  - `__str__` returns a concise summary including slug and title.
  - `__repr__` returns a precise constructor-like form.

Chapter
- Fields:
  - `id: ChapterId` — required; must match `number` when normalized.
  - `number: int` — required; positive; `make_chapter_id(number)` defines normalized id.
  - `title: str` — required; validated via `title()`.
  - `text: str` — required; validated via `markdown()` (opaque wrapper semantics; accepts empty string).
- Invariants:
  - `number > 0`.
  - `id` has `ch_` prefix and parses to the same `number` via `parse_chapter_id()`.
  - `title` is non-empty after trim and within length bounds.
  - `text` is a string; `markdown()` must accept it.
- Mutators:
  - `retitle(new_title: str) -> None` — validates via `title()` and assigns normalized result.
  - `renumber(new_number: int) -> None` — validates `new_number`, recomputes id with `make_chapter_id()`, and assigns both atomically.
  - `replace_text(full_text: str) -> None` — validates via `markdown()` and assigns. Note: append-only behavior is not enforced here; it is handled in L-05 on dedicated operations.
- Representation:
  - `__str__` includes `id` and `title`.
  - `__repr__` is constructor-like for debugging.

## Validation and Normalization
- Perform validation in `__post_init__` for both entities:
  - Normalize and assign validated fields (e.g., trimmed title) so representations always reflect normalized state.
  - When converting `number` and `id`, use `parse_chapter_id()` and `make_chapter_id()` to ensure consistency.
- Mutator methods must reuse the same helpers to avoid duplicate logic.
- Raise `InvariantViolation` with actionable messages; include offending numeric values where relevant.
- Allow `text` to be an empty string; reject `None`.

Message guidance examples (not full strings to copy):
- Book title empty: mention “Title cannot be empty”.
- Slug invalid: rely on `slug()` to raise `SlugInvalid` with guidance.
- Chapter number invalid: “Chapter number must be positive, got N”.
- Chapter id mismatch: include both provided id and expected normalized id.

## Equality, Hashing, and Immutability
- Entities are mutable; default dataclass equality compares by fields. This is acceptable for MVP.
- Do not make entities hashable; default dataclasses are unhashable when mutable.
- Avoid `frozen=True`; L-04 explicitly allows mutators.

## Error Model
- Use only domain errors:
  - `InvariantViolation` for invalid fields or cross-field inconsistencies.
  - `SlugInvalid` arises from `slug()` validation and should be allowed to propagate.
- Avoid leaking implementation details in messages (no tokenizer names, file paths, or provider specifics).

## Implementation Plan
- Create `book.py` and `chapter.py` with dataclasses and `__post_init__` validations.
- Delegate all field validations to the existing helpers:
  - `book_id()`, `slug()`, `title()`, `markdown()`
  - `make_chapter_id()`, `parse_chapter_id()`
- Normalize on assignment:
  - Example normalization flows described as prose (no code):
    - Book: trim and validate title; validate slug; trim book id; assign normalized values.
    - Chapter: ensure `number` positive; parse `id` to obtain parsed number; assert equality with `number`; normalize `id` via `make_chapter_id(number)` to enforce zero-padding; title via `title()`; text via `markdown()`.
- Implement mutators to reuse the same helpers and keep invariants intact.
- Add concise `__str__` and faithful `__repr__`.

## Re-exports
- Update `liriac/domain/__init__.py` to import and include `Book` and `Chapter` in `__all__`.
- Keep import order consistent with existing exports.

## Testing Strategy
Location: `tests/domain/test_entities.py`.

Book tests
- Construction happy paths with valid `id`, `slug`, and `title`.
- Invalid cases:
  - Empty or whitespace-only title raises `InvariantViolation`.
  - Invalid slug raises `SlugInvalid` (e.g., uppercase or spaces).
  - Empty `id` raises `InvariantViolation`.
- Mutator behavior:
  - `retitle` applies trimming and normalization; rejects empty/whitespace-only titles.
  - Optional `reslug` validates and updates slug or raises `SlugInvalid`.
- Representation:
  - `__str__` contains slug and title.
  - `__repr__` round-trippable enough for debugging assertions.

Chapter tests
- Construction happy paths:
  - Matching `id` and `number` (e.g., `id="ch_03"`, `number=3`) with valid title and any text (including empty string).
- Invalid cases:
  - `number <= 0` raises `InvariantViolation`.
  - `id` with wrong prefix or non-numeric suffix triggers `InvariantViolation` via `parse_chapter_id()`.
  - Mismatch between `id` and `number` raises `InvariantViolation` with both values mentioned.
  - Empty or whitespace-only title raises `InvariantViolation`.
  - `text=None` raises `InvariantViolation` via `markdown()`.
- Mutator behavior:
  - `retitle` trims and validates.
  - `renumber` updates both `number` and `id` consistently; verify normalization (e.g., 3 becomes `ch_03`).
  - `replace_text` accepts empty string but not `None`.
- Representation:
  - `__str__` includes the `id` and title.
  - `__repr__` shows field contents deterministically.

Cross-cutting tests
- Catchability as `DomainError` at the app boundary where meaningful.
- No IO or adapter imports from entities.
- Import surface re-exported via `liriac.domain`.

## Naming and Style
- Dataclass field names should be short and clear: `id`, `slug`, `title`, `number`, `text`.
- Keep method names verbs with clear intent: `retitle`, `renumber`, `replace_text`.
- Messages refer to business terms: Book, Chapter, ChapterId, Title, Slug.

## Performance and Memory
- Entities keep only required fields.
- Avoid heavy normalization; reuse simple helper checks.
- No caches or derived fields beyond basic normalization.

## Future Considerations
- Add optional fields to Book (genre, audience, tone) when needed.
- Introduce richer chapter metadata (pov, synopsis) later; ensure invariants remain localized.
- Consider a dedicated `ChapterText` VO if semantics grow.
- If entities become numerous, split entity modules into a subpackage (e.g., `liriac/domain/entities/`).

## Acceptance Criteria
- Book and Chapter defined as dataclasses with fields and invariants above.
- Constructor validation normalizes fields and raises domain errors on invalid inputs.
- Mutators maintain invariants and normalization.
- Entities importable from `liriac.domain`.
- Unit tests exercise happy/invalid paths, mutators, and representations.

## Verification
- Run the test suite and ensure new tests pass with existing ones.
- Command to run tests can be executed with the project’s standard pytest invocation.
- Add the tests before implementation to confirm intent, then iterate until green.

## Checklist
- Book dataclass with validation and `retitle`.
- Chapter dataclass with validation, `retitle`, `renumber`, and `replace_text`.
- No external dependencies or adapter imports.
- Re-exported from `liriac.domain`.
- Tests added and passing.
