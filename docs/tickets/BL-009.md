# BL-009 — OpenAPI Schema & Frontend Type Generation

Status: Planned  
Owner: TBA  
Labels: backend, openapi, drf-spectacular, typescript, contract, ci  
Blocks: BL-010 (Frontend DTOs & client helpers), BL-015 (Suggestions UI)  
Depends on: BL-005 (DRF endpoints/base), BL-006 (Autosave), BL-008 (WebSocket consumer — not part of OpenAPI)

## Summary
Establish a reliable OpenAPI contract for the REST API using DRF Spectacular and generate strongly-typed TypeScript DTOs for the frontend. Publish the schema to `backend/schema.yaml`, wire Makefile workflows, and add a contract check to prevent schema/types drift.

## Goals
- Generate OpenAPI v3 schema via DRF Spectacular.
- Publish schema to `backend/schema.yaml` (committed to repo).
- Generate TypeScript types to `frontend/src/api/types.ts` with `openapi-typescript`.
- Add a contract check to CI/local (`make check`) to fail on drift.
- Document developer workflow for schema and type generation.

## Non-Goals
- Define WebSocket contracts in OpenAPI (Channels/WebSocket remains documented in markdown).
- Introduce new REST endpoints beyond current scope.
- End-to-end client implementation (covered by BL-010/BL-015).

## API Surface (covered by schema)
- Books:
  - `GET /api/v1/books/`
  - `POST /api/v1/books/`
  - `GET /api/v1/books/{id}/`
  - `GET /api/v1/books/{book_pk}/chapters/`
  - `POST /api/v1/books/{book_pk}/chapters/`
- Chapters:
  - `GET /api/v1/chapters/{id}/`
  - `PUT /api/v1/chapters/{id}/`
  - `PATCH /api/v1/chapters/{id}/` (restricted fields)
  - `POST /api/v1/chapters/{id}/autosave/`
- Personas:
  - `GET /api/v1/personas/`
  - `POST /api/v1/personas/`
  - `GET /api/v1/personas/{id}/`
  - `PUT /api/v1/personas/{id}/`
  - `PATCH /api/v1/personas/{id}/`
- Health:
  - `GET /api/v1/health/`
- Notes:
  - WebSocket endpoints under `/ws/...` are intentionally excluded from OpenAPI; documented separately.

## Schema Conventions
- Use DRF Spectacular defaults with explicit `SPECTACULAR_SETTINGS`:
  - Title: "Liriac API", version "1.0.0", path prefix `/api/v1/`, `SERVE_INCLUDE_SCHEMA=False`.
- Annotate views with `@extend_schema` for non-standard responses (e.g., health, autosave).
- Deterministic operationIds (e.g., `books_list`, `chapters_autosave_create`) to keep generated types stable.
- Components for common shapes:
  - `Book`, `ChapterDetail`, `ChapterList`, `ChapterCreate`
  - `Persona`
  - `Autosave` (request), inline response schema for autosave result
  - `Paginated*` results

## Implementation Plan
1. DRF Spectacular config
   - Confirm `SPECTACULAR_SETTINGS` in Django settings (title, version, prefix).
   - Ensure URL route `GET /api/schema/` (SpectacularAPIView) is present.
2. Schema generation
   - Add/verify Makefile target:
     - `make schema` → `backend/schema.yaml`
3. Type generation
   - Add/verify Makefile target:
     - `make fe-typegen` → `frontend/src/api/types.ts` (uses `openapi-typescript`)
4. Contract check
   - In `make check`, run:
     - `make schema` then `make fe-typegen`
     - Optionally: add a check step (CI) to assert no diff after regeneration.
5. Documentation
   - Add short contributor notes to `docs/00-draft.md` (or a dev guide) on how to regenerate schema and types.

## Developer Workflow
- Regenerate schema after backend changes:
  - `make schema`
- Regenerate frontend types:
  - `make fe-typegen`
- Full quality gate locally:
  - `make check` (lint, typecheck, tests, schema, typegen, and FE build)

## Tests (Contract)
- Add a CI/job step (or local pre-commit guidance):
  - Regenerate schema and types, then fail if `git diff` is non-empty.
- Optional lightweight test:
  - Smoke test that `/api/schema/` view returns 200 locally (served only in dev/test).

## Acceptance Criteria
- `backend/schema.yaml` exists and reflects current REST endpoints and components.
- `frontend/src/api/types.ts` is generated from `schema.yaml` and passes TypeScript checks.
- `make schema` and `make fe-typegen` work on a clean environment (no manual setup beyond Node + Python).
- `make check` includes schema/type generation; CI fails on contract drift.
- Endpoint-specific annotations (e.g., autosave response) appear correctly in the OpenAPI document.

## Risks & Mitigations
- Drift between backend schema and frontend types:
  - Mitigate with deterministic generation in `make check` and CI.
- Breaking changes to operationIds:
  - Stabilize operationId naming; treat changes as breaking and bump API version as needed.
- Over-documentation of internal fields:
  - Use serializer `read_only_fields` and targeted `@extend_schema` to control exposure.

## Estimation
- Effort: S (0.5–1 day including verification, docs, and CI wiring).

## Checklist
- [ ] DRF Spectacular configured and `/api/schema/` reachable in dev/test.
- [ ] `make schema` generates `backend/schema.yaml` deterministically.
- [ ] `make fe-typegen` generates `frontend/src/api/types.ts`.
- [ ] Contract check added to `make check`/CI to fail on drift.
- [ ] Docs updated with regeneration instructions.
