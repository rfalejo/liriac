# BL-012B — Library: Book Creation & Editing

Status: Planned  
Last updated: 2025-09-20  
Owners: FE + BE  
Depends on: BL-012 (Library dashboard), BL-009/BL-010 (OpenAPI & Types), BL-005 (DRF serializers)

## Summary

Add book creation and editing flows to the Library dashboard. Users can:
- Create a new book via a modal dialog (Title + Slug).
- Edit an existing book’s Title and Slug via a modal dialog.
- After creation/update, the books list refreshes and the selected/edited book is highlighted. The URL `?book={id}` reflects the selection.

## Goals

- Simple “New Book” dialog integrated into the Books panel.
- Inline validation for required Title and Slug format, with slug auto-generated from Title (editable).
- Server-side uniqueness and normalization (slugify) enforced; surface API errors cleanly.
- Editing flow accessible on the selected book (e.g., action button or context menu).
- React Query cache update/invalidations without breaking pagination or search filters.

## Non-Goals (This Ticket)

- Delete books (future).
- Bulk operations or advanced metadata (author, cover, description).
- Cross-page navigation beyond existing Library and Editor routes.
- Permissions/auth (local-only MVP).

## UX Acceptance Criteria

- “New Book” button is visible in the Books panel header.
- Clicking “New Book” opens a modal (role="dialog", focus trapped, Esc closes):
  - Fields:
    - Title (required)
    - Slug (required, auto-filled from Title using slugify; user can edit)
  - Validation:
    - Title: non-empty after trim
    - Slug: non-empty; client pattern `[a-z0-9-]+`; server enforces normalization/uniqueness
  - Actions: Create (primary), Cancel (secondary)
  - Submitting shows a busy state; on success:
    - Books list refetches or cache updates; new book appears
    - The new book becomes selected; URL updated with `?book={id}`
    - Dialog closes and focus returns to Books list
  - On error:
    - API validation errors (e.g., duplicate slug) render inline below the field
    - Network errors show a non-intrusive error message with Retry
- Editing:
  - An “Edit” action is available for the selected book (button or menu).
  - Opens the same dialog pre-filled with current Title/Slug.
  - Submit issues PATCH; on success, books list cache updates; selection preserved; dialog closes.
- Accessibility:
  - Dialog has `aria-labelledby` and `aria-describedby`, is keyboard operable (Tab/Shift+Tab cycle), supports Esc to close.
  - Form inputs have associated labels and visible error text with `aria-live="polite"`.

## Backend Changes

- Endpoints:
  - Create (already available): `POST /api/v1/books/` → 201 with `Book`.
  - Update (to add): `PATCH /api/v1/books/{id}/` (and optionally `PUT`) → 200 with updated `Book`.
- Implementation:
  - In `apps.library.api.views.BookViewSet` add `mixins.UpdateModelMixin` to enable update routes.
  - `BookSerializer` already normalizes slug in `validate_slug`; keep as-is.
- OpenAPI/Schema:
  - Regenerate schema to include `books_update` / `books_partial_update` operations.
- Tests (backend):
  - Add tests covering:
    - PATCH updates title and/or slug
    - Slug normalization and uniqueness errors (400)
    - List/search/order unaffected by updates

## Frontend Changes

- API client (`src/api/endpoints.ts`):
  - Add:
    - `createBook(payload: { title: string; slug: string })`
    - `updateBook(id: number, payload: { title?: string; slug?: string })` (PATCH)
- UI:
  - Books panel header: add “New Book” button.
  - Modal dialog component:
    - Props: mode = "create" | "edit", initial values (for edit), callbacks.
    - Internal state: title, slug; slug auto-generates from title (debounced) unless user manually edits slug once (then keep manual).
  - Integrate into `BooksList` or `LibraryPage`:
    - Create flow: open dialog, call mutation, on success invalidate or update `['books', params]`; select the new book and update `?book`.
    - Edit flow: open dialog with selected book; on success update cache entry in place; preserve pagination and selection.
- React Query:
  - Use `useMutation` + `queryClient.invalidateQueries({ queryKey: ['books'] })` or targeted cache update for the relevant `queryKey` including params.
- Validation & Errors:
  - Client-side trim + pattern check for slug; still submit to server.
  - Show server error messages inline (map serializer field errors).
- Styling:
  - Tailwind-based modal and form controls consistent with existing components.

## Testing

- Frontend (Vitest + RTL):
  - Dialog open/close behavior; keyboard interactions (Esc, Enter).
  - Form validation (empty title/slug; invalid slug pattern).
  - Mutation success path updates cache and selection; URL param reflects selection.
  - API error handling renders server messages.
- Backend (pytest + DRF):
  - PATCH happy path, uniqueness violation, normalization.
- Contract:
  - Regenerate `backend/schema.yaml` and `frontend/src/api/types.ts`; ensure no drift (`make contract-check`).
- CI:
  - Lint, typecheck (tsc + mypy), and all tests pass.

## Analytics & Logging (Local MVP)

- Backend: log create/update actions at info level (JSON logs later).
- Frontend: optional console debug in dev; no PII; no external telemetry.

## Rollout & Migration

- No DB migrations. Add update route and deploy.
- Backward compatible with existing list/create flows.

## Edge Cases

- Creating while a search filter is applied:
  - Invalidate and re-fetch; the new book may not appear if it doesn’t match the filter; still select it programmatically and reflect in URL.
- Creating on a paginated list:
  - If not on page 1, selection might point to an item off-screen; keep selection and consider a toast: “Created ‘X’ — jump to it?” (optional).
- Rapid edits:
  - Disable submit while request in flight; prevent duplicate submissions.

## Open Questions

- Do we pre-select and scroll the created book into view if it’s not on the current page (or adjust page)?
- Should we expose PUT in addition to PATCH? (PATCH is sufficient for MVP.)
- Any extra fields for Book planned soon (e.g., author)? If so, design dialog for extensibility.

## Implementation Tasks

- Backend
  - Add `UpdateModelMixin` to `BookViewSet`; allow PATCH.
  - Tests for update + uniqueness errors.
  - Regenerate OpenAPI schema.
- Frontend
  - Add `createBook` and `updateBook` API functions.
  - Build `BookDialog` component with form and validation.
  - Wire “New Book” and “Edit” actions into Library UI.
  - React Query mutations + cache updates + URL selection.
  - Component and hook tests for both flows.
- Contracts & Tooling
  - `make schema fe-typegen`
  - `make check` (ensure no drift; CI green).
- Docs
  - Link this ticket from backlog (BL-012 extension) and update any relevant developer notes.

## API Examples

- Create
  - Request: `POST /api/v1/books/` `{ "title": "El viajero", "slug": "el-viajero" }`
  - Response: `201` `{ "id": 7, "title": "El viajero", "slug": "el-viajero", "created_at": "...", "last_opened": null }`
- Update
  - Request: `PATCH /api/v1/books/7/` `{ "title": "El viajero (rev)" }`
  - Response: `200` `{ "id": 7, "title": "El viajero (rev)", "slug": "el-viajero", ... }`

## References

- `backend/apps/library/api/views.py` (`BookViewSet`)
- `backend/apps/library/api/serializers.py` (`BookSerializer.validate_slug`)
- `frontend/src/features/library/BooksList.tsx`, `frontend/src/app/pages/LibraryPage.tsx`
- Backlog: `docs/02-backlog.md` (BL-012)
