# BL-013A — Bottom Status Bar (TUI-style)

Status: Proposed  
Owners: Frontend  
Depends on: BL-011 (Routing/Layout), BL-014 (Autosave UX), BL-007/008/015 (Suggestions)  
Out of scope: Backend API changes; Top Bar implementation (tracked separately)

## Objective

Introduce a single, persistent, bottom-anchored status bar across the SPA that:
- Mimics a TUI/statusline (compact, monospace clusters, separators).
- Surfaces concise, ephemeral feedback and the most relevant shortcuts.
- On the Editor screen, hosts editor-specific state (mode, autosave), a prompt toggle, and streaming status.

This consolidates disparate status UI (e.g., the Editor footer) into one consistent Bottom Bar rendered by the root layout.

## Non-Goals

- Adding new backend endpoints.
- Implementing the Top Bar (navigation/global controls). That will be a separate ticket.
- Reworking suggestions transport or autosave semantics beyond what’s needed for the bar.

## UX & Behavior

### Placement
- Permanently docked to the bottom of the viewport (sticky), across routes.
- Z-index above main content but below modals/dialogs.
- Full width container constrained by the same max width as the main content.

### Visual Style
- TUI-like compact bar: monospace, separators “•” and “|”, subtle translucent background.
- Dark/light aware via existing Tailwind theme classes.
- Truncates gracefully; use ellipsis for overflowing middle content.

### Structure (slots)
- Left: short page/breadcrumb context (e.g., “Library”, “Book 1 — Chapter 2 — Title”).
- Middle: dynamic info:
  - Library: selection/pagination hints.
  - Editor: “Mode: Manual • Autosave: active (every 10s)” or “saving…”, suggestions streaming status.
  - Transient messages (e.g., “Save disabled (BL-014)”) appear here with aria-live.
- Right: a minimal keyboard shortcuts cluster (1–3 keys), e.g.:
  - Library: [Enter] Open, [C] New chapter
  - Editor: [Shift+Tab] Prompt, [Esc] Blur/Close, [Ctrl/Cmd+S] Save (disabled)

### Editor-specific additions
- Prompt toggle: [Shift+Tab] opens a compact Prompt popover anchored to the right side of the bar.
- Streaming indicator (when active): “Generating… 128 tokens [Esc × 2] Stop”
- Mode badge: “Mode: Manual” (Suggestion mode in future tickets).
- Autosave indicator: “Autosave: active (every 10s)” or “saving…” or “saved 2s ago”.

### Accessibility
- The bar is `role="status"` with `aria-live="polite"` for transient updates.
- Shortcut keys are rendered as kbd elements with clear labels and focusable tooltip targets if needed.
- Popover is a proper dialog with labelled controls and escape-to-close.

### Responsiveness
- On small screens, collapse shortcut labels to icons + kbd or minimal “?” shortcut.
- Middle slot remains first-class for autosave/streaming messages.

## Component Design

### New: `BottomBar` (global)
- Rendered from `AppLayout`, always present.
- Props: none (consumes context).
- Layout:
  - Left cluster: text/breadcrumb provided by routes.
  - Middle cluster: info + ephemeral message area (aria-live).
  - Right cluster: a small set of shortcuts; collapsed on narrow screens.

### New: `BottomBarProvider` and `useBottomBar()`
- Provider stores route-contributed content and bar state.

Types (proposal):
```ts
type Shortcut = {
  keys: string;           // e.g., "Shift+Tab", "Ctrl+S", "J/K"
  label: string;          // e.g., "Prompt", "Save (disabled)"
  action?: () => void;    // optional for clickable hints
  ariaLabel?: string;
};

type EphemeralMessage = {
  text: string;
  kind?: 'info' | 'warn' | 'error';
  timeoutMs?: number;     // default 2000
};

type BottomContribution = {
  left?: string;          // short breadcrumb/label
  middle?: string;        // primary info line (autosave, streaming)
  rightShortcuts?: Shortcut[];
  editor?: {
    mode?: 'Manual' | 'Suggestion';
    autosave?: 'active' | 'saving' | { savedAgoSec: number };
    streaming?: { tokens?: number; state: 'idle' | 'running' | 'stopping' };
    showPromptToggle?: boolean; // shows [Shift+Tab] Prompt
  };
};

type BottomBarAPI = {
  set(contrib: BottomContribution): void;
  patch(partial: Partial<BottomContribution>): void;
  clear(): void;
  pushMessage(msg: EphemeralMessage): void;
};
```

Hook usage:
```ts
const bar = useBottomBar();
bar.set({
  left: 'Library',
  middle: 'Manage your books and chapters • Pg 1',
  rightShortcuts: [
    { keys: '?', label: 'Shortcuts' },
    { keys: 'N', label: 'New book' },
    { keys: '/', label: 'Search' },
  ],
});
```

### New: `PromptPopover` (Editor only)
- Small anchored dialog from the right side of the Bottom Bar.
- Controlled by `useBottomBar().patch({ editor: { ... }})` and a local `usePrompt()` hook (if we choose).
- Sends start-of-suggestions (existing flow in future BL-015) or just collects text for now (non-blocking UX).
- Keyboard:
  - Open/close: Shift+Tab
  - Close: Esc
  - Submit: Enter (with modifier if multiline is needed later)

### Utilities
- `ShortcutKey` presentational component for consistent kbd styling.
- `useEphemeralMessage` integrated in the provider to show/dismiss transient status line messages.

## Top Bar Hand-off (Future)

When a Top Bar is introduced, it should host persistent/global context so the Bottom Bar can stay lean and focused on ephemeral state.

- Branding/Breadcrumbs: App name + “Book › Chapter › Title”; quick jump menus.
- Global Search: Input or icon to open search/palette.
- Quick Actions: New Book/Chapter, Reorder, Edit, Settings.
- Mode Toggle: Manual/Suggestion switch (Bottom Bar only echoes current mode).
- Prompt Trigger: Button to open the prompt popover (Bottom keeps the keyboard shortcut).
- Context Chips: Personas on/off count, included chapters count; click opens context modal.
- Model/Provider: Current model name (e.g., gpt-4o-mini) and selector.
- Document Meta: Word count, reading time (periodically updated).
- Connectivity/Env: WS/API connectivity indicator, DEV flag; notifications badge.
- Theme/Help: Theme toggle, “?” to open full shortcuts overlay.

Bottom Bar keeps:
- Ephemeral status: “Save disabled (BL-014)”, “saving…”, “saved 2s ago”.
- Streaming progress: “Generating… 128 tokens [Esc × 2] Stop”.
- Current mode label (“Mode: Manual”) — not the toggle.
- A minimal set of the most relevant shortcuts for the current screen.

## Integration Plan

1) Add `BottomBarProvider` and `BottomBar` to `AppLayout`
- Wrap children with provider.
- Render `<BottomBar />` as the last element in `AppLayout` root so it stays bottom-fixed.

2) Library route (`LibraryPage`)
- Publish:
  - left: “Library”
  - middle: “Manage your books and chapters…”
  - rightShortcuts: `?`, `/` Search, `N` New book
- BooksList/ChaptersList can patch the bar (e.g., pagination state, selection hints).

3) Editor route (`EditorPage`)
- Remove the existing local footer; replace with Bottom Bar contributions:
  - left: “Book {bookId} — Chapter {chapterId}{ — Title}”
  - middle (keep copy used by existing tests):
    - “Mode: Manual • Autosave: active (every 10s)”
    - When save key pressed: pushMessage(“Save disabled (BL-014)”) — same string so tests stay green.
  - rightShortcuts: `Shift+Tab` Prompt, `Esc` Blur/Close, `Ctrl/Cmd+S` Save (disabled)
- Wire keyboard handlers:
  - Keep current Ctrl/Cmd+S prevention and call `pushMessage`.
  - Add Shift+Tab toggle to open `PromptPopover`.
  - Keep Esc to blur textarea or close popover when open.

4) Suggestions state (prep)
- Expose streaming indicator in `editor.streaming` derived from hooks used by BL-015.
- Show “Generating… {tokens} [Esc × 2] Stop” while running.
- Stop action integrated into `rightShortcuts` when active.

5) Theming & A11y
- Tailwind classes for dark/light; `role="status"` and `aria-live` on middle slot.

6) Tests
- Unit tests for `BottomBar` rendering and provider
- Update Editor tests to look for content in the bar (text remains unchanged to avoid breakage).
- Keyboard interaction tests remain valid (Ctrl/Cmd+S shows same message).

## Copy & Examples

Global (library):
```
Library | Manage your books and chapters • Pg 1 | [?] Shortcuts  [/] Search  [N] New book
```

Editor (idle):
```
Book 1 — Chapter 2 — Test Chapter | Mode: Manual • Autosave: active (every 10s) | [Shift+Tab] Prompt  [Esc] Blur  [Ctrl/Cmd+S] Save (disabled)
```

Editor (after Ctrl+S):
```
… | Save disabled (BL-014) | …
```

Editor (streaming):
```
… | Generating… 128 tokens  [Esc × 2] Stop | …
```

## Accessibility Details

- Middle slot: `aria-live="polite"` for ephemeral messages.
- Shortcuts use `<kbd>` with readable text; high contrast focus states.
- Popover is a dialog with labelled input and described-by helper text.

## Performance

- Provider stores lightweight strings/arrays; renders once per route transition or local patch.
- Shortcut rendering is static unless updated; ephemeral messages use timeouts and minimal re-renders.

## Mocks & Placeholders (Dev/Test)

To decouple this ticket from BL-014 (Autosave UX) and BL-007/008/015 (Suggestions), ship frontend-only mocks guarded by a dev/test flag. These preserve copy and interactions so existing tests remain valid.

- Autosave mock (BL-014):
  - Middle slot shows “Autosave: active (every 10s)” by default.
  - Provide a lightweight timer in the provider to simulate a cycle: patch `editor.autosave` to "saving", then after 800–1200ms patch to `{ savedAgoSec: 0 }` and increment every second up to 5s before clearing.
  - Ctrl/Cmd+S continues to prevent default and calls `pushMessage('Save disabled (BL-014)')` (exact copy retained).

- Suggestions/Prompt mock (BL-007/008/015):
  - `PromptPopover` opens via [Shift+Tab], accepts text, and on submit starts a mock “stream”.
  - While running, provider sets `editor.streaming = { state: 'running', tokens }` and increments `tokens` every ~80ms up to 128, then transitions to `'idle'` and optionally pushes an informational message.
  - [Esc × 2] sets a short (e.g., 600ms) double-escape window: first Esc marks “stopping”, second Esc within the window invokes a mock `stop()` that sets `'idle'`.

- Provider API surface (mock helpers):
  - `startMockStream(prompt: string): void`, `stopMockStream(): void`
  - `simulateAutosaveCycle(): void` for manual triggers in stories/tests.
  - These are no-ops in production builds.

- Feature flag and scope:
  - Enabled when `import.meta.env.DEV` is true, or when `globalThis.VITE_ENABLE_STATUSBAR_MOCKS !== false` (default true in dev/test).
  - In production, the bar renders but mocks are disabled; real hooks will replace them when dependent tickets land.

- A11y & copy guarantees:
  - All messages keep the exact strings already used in tests (e.g., “Save disabled (BL-014)”, “Autosave: active (every 10s)”).
  - `aria-live="polite"` remains on the middle slot; popover stays an accessible dialog.

- Removal plan:
  - When BL-014/015 integrate real autosave/stream hooks, replace mock setters with real selectors/effects and delete mock helpers behind the flag without altering user-facing copy.

## Implementation Tasks

- FE-1: Create `BottomBarProvider` and `useBottomBar()` hook (Context or Zustand).
- FE-2: Build `BottomBar` UI (left/middle/right clusters, responsive).
- FE-3: Add `ShortcutKey` component.
- FE-4: Integrate provider + bar into `AppLayout` (permanent bottom).
- FE-5: Replace EditorPage footer with Bottom Bar contributions; keep exact copy for autosave and save-disabled messages.
- FE-6: Add `PromptPopover` anchored to bar (toggle Shift+Tab).
- FE-7: Wire keyboard handlers to provider (Ctrl/Cmd+S message; Esc handling; Shift+Tab toggle).
- FE-8: Tests: unit (bar, provider), integration (Editor shortcuts), ensure existing text assertions pass.
- FE-9: Docs: update README or design docs to reference the status bar patterns.

Estimates (rough):
- FE-1..FE-4: 1.5d
- FE-5..FE-7: 1.5d
- FE-8: 0.5d
- Total: ~3.5d

## Acceptance Criteria

- The Bottom Bar is visible on all pages, stuck to bottom.
- Library route shows a shortcuts cluster (at least “?”, “/”, “N”).
- Editor route:
  - Displays “Mode: Manual • Autosave: active (every 10s)” when idle.
  - Pressing Ctrl/Cmd+S shows “Save disabled (BL-014)” transiently.
  - Shift+Tab toggles the prompt popover; Esc closes it or blurs textarea.
- Streaming UI (when wired in BL-015): shows “Generating… {tokens} [Esc × 2] Stop”.
- A11y: middle cluster is `aria-live="polite"`, bar is navigable, kbd labels readable.
- Tests pass without needing to change existing copy used in specs.

## Risks & Mitigations

- Test fragility due to markup changes:
  - Keep exact strings; tests assert by text, not DOM position.
- Overcrowding on small screens:
  - Collapse or reduce shortcuts to “?” and the most relevant action.
- State management complexity:
  - Keep provider API minimal; routes set/patch/clear on mount/unmount.

## Open Questions

- Should shortcuts be clickable (invoke actions) or informative only in MVP?
- Should the prompt accept multiline input (Shift+Enter) now or later?
- Persist last prompt content between sessions?

## Follow-ups

- BL-015 tie-in: connect streaming state to the bar and integrate Stop action.
- Shortcut overlay (“?”) mini modal listing all shortcuts per route.
- Top Bar (future): migrate persistent/global elements upward to keep the Bottom Bar focused on ephemeral feedback.
