# BL-013B — Top Bar (Global Navigation & Context)

Status: Proposed  
Owners: Frontend  
Depends on: BL-011 (Routing/Layout), BL-013A (Bottom Bar), BL-012 (Library), BL-014 (Autosave UX), BL-007/008/015 (Suggestions)  
Out of scope: Backend API changes (search/indexing), complex analytics, auth

## Objective

Introduce a single, persistent Top Bar that anchors global navigation and persistent context across the SPA. It complements the Bottom Bar (BL-013A) by hosting non-ephemeral controls and indicators:

- Global brand and breadcrumb (book › chapter).
- Global search / command palette.
- Quick actions (New Book/Chapter, Reorder, Edit).
- Context chips (Personas enabled count, Included chapters count).
- Prompt trigger (opens editor prompt drawer/popover).
- Model/provider indicator and selector (future).
- Document meta (word count, reading time).
- Connectivity/env badges (DEV, API/WS).
- Theme toggle and Help (“?” overlay).

The Bottom Bar remains focused on transient status (saving…, saved 2s ago, streaming tokens, minimal shortcuts).

## Non-Goals

- Implementing backend search endpoints (use lightweight client-side search/mocks for MVP).
- Replacing Bottom Bar functionality (it stays for ephemeral status and compact shortcuts).
- Authentication or multi-user roles.

## UX & Behavior

### Placement
- Sticky header at the top of the viewport, spans full width, constrained to the app’s max content width.
- Z-index above main content but below modals/dialogs/command palette overlays.
- Safe-area aware (padding for notches).

### Visual Style
- Minimal, translucent surface with subtle border; dark/light via Tailwind.
- Compact layout, monospace badges for technical indicators (“DEV”, “WS: connected”).
- Clear focus rings for interactive elements; accessible contrast.

### Structure (slots)
- Left: Brand (“liriac”) + Breadcrumb.
  - Library: “Library”.
  - Editor: “Book: ‹title› › Chapter: ‹n› ‹title›”.
- Center: Search / Command Palette entry (inline on desktop; collapses to icon on small screens).
- Right: Actions and indicators:
  - Quick actions: New Book, New Chapter, Reorder, Edit.
  - Context chips: Personas: N, Chapters: M (click → open Context modal).
  - Prompt: button to open prompt popover/drawer (Bottom Bar keeps kbd shortcut).
  - Model: “gpt-4o-mini” (future dropdown).
  - Document meta: “Words: 1,234 • ~6 min”.
  - Connectivity/env: “DEV” badge; API/WS status (green/amber/red).
  - Theme toggle; Help (“?” opens shortcuts overlay).

### Keyboard
- “/”: Focus search field (or open palette if compact mode).
- “Cmd/Ctrl+K”: Open command palette.
- “Shift+Tab”: Prompt (delegates to existing editor flow; Bottom Bar advertises the shortcut).
- “F10”: Open Context modal (personas/chapters).
- “?”: Open shortcuts overlay for the current route.
- “T”: Toggle theme (optional; kept discoverable by tooltip).

### Accessibility
- Landmark: `<header role="banner">`; breadcrumb uses `aria-label="Breadcrumb"`.
- Search uses `role="search"`; palette is a dialog with labelled input and listbox.
- Focus traps and ESC-to-close for overlays (palette, help, prompt).
- All actionable icons include aria-labels and tooltips; indicators have `title` attributes.

### Responsiveness
- On small screens:
  - Collapse center search to an icon that opens the palette.
  - Show only the most relevant quick actions (e.g., New, Prompt, Help).
  - Move lower-priority indicators behind a “…” menu.

## Component Design

### New: `TopBar` (global)
- Renders from `AppLayout` header area.
- Consumes context from `TopBarProvider` for breadcrumb, actions, chips, meta, and status badges.
- Emits keyboard bindings (delegated to provider) for palette focus and quick toggles.

### New: `TopBarProvider` and `useTopBar()`
- Stores route-contributed content and shared state.
- Coordinates the command palette and search focus.

Types (proposal):
```ts
type QuickAction = {
  id: string;
  label: string;
  icon?: React.ReactNode;
  onClick?: () => void;
  ariaLabel?: string;
  hotkey?: string; // e.g., "N", "F10"
  disabled?: boolean;
};

type ContextChip = {
  id: string;
  label: string;         // "Personas: 2", "Chapters: 3"
  onClick?: () => void;  // opens context modal
  ariaLabel?: string;
};

type Connectivity = {
  api: 'online' | 'degraded' | 'offline';
  ws: 'connected' | 'connecting' | 'disconnected';
  env?: 'DEV' | 'TEST' | 'PROD';
};

type DocMeta = {
  words?: number;
  readingMinutes?: number; // rounded
};

type TopContribution = {
  breadcrumb?: string;         // short breadcrumb string
  showSearch?: boolean;        // center search/palette visible
  quickActions?: QuickAction[]; 
  contextChips?: ContextChip[];
  promptEnabled?: boolean;     // shows prompt button
  modelLabel?: string;         // "gpt-4o-mini"
  meta?: DocMeta;
  connectivity?: Connectivity; // provider may compute/patch
};

type TopBarAPI = {
  set(contrib: TopContribution): void;
  patch(partial: Partial<TopContribution>): void;
  clear(): void;

  // Command palette
  openPalette(): void;
  closePalette(): void;
  registerCommands(cmds: CommandItem[]): void;
  unregisterCommands(ids: string[]): void;

  // Dev/test helpers (no-ops in prod)
  setMockConnectivity(status: Connectivity): void;
  setMockDocMeta(meta: DocMeta): void;
};
```

Hook usage:
```ts
const top = useTopBar();
top.set({
  breadcrumb: 'Book: El viajero › Chapter 03',
  showSearch: true,
  quickActions: [
    { id: 'new-book', label: 'New Book', hotkey: 'N' },
    { id: 'new-chapter', label: 'New Chapter' },
    { id: 'reorder', label: 'Reorder' },
  ],
  contextChips: [
    { id: 'personas', label: 'Personas: 2' },
    { id: 'chapters', label: 'Chapters: 3' },
  ],
  promptEnabled: true,
  modelLabel: 'gpt-4o-mini',
  meta: { words: 1234, readingMinutes: 6 },
});
```

### New: `CommandPalette` (overlay dialog)
- Unified palette for navigation and actions; opens via “Cmd/Ctrl+K” or search icon in compact mode.
- Items may be:
  - Routes: “Open: Book …”, “Open: Chapter …”
  - Actions: “New Book”, “New Chapter”, “Reorder chapters”, “Edit…”, “Open Context”, “Toggle Theme”
- List behaviors:
  - Arrow keys to navigate; Enter to execute; ESC closes.
  - Optional grouping: “Navigate”, “Actions”.

Types:
```ts
type CommandItem = {
  id: string;
  kind: 'action' | 'route';
  label: string;
  hint?: string;          // right aligned metadata, e.g., hotkey
  run: () => void;
};
```

### Utilities
- `ShortcutKey` from BL-013A reused for consistent kbd rendering in tooltips.
- `usePaletteHotkeys` in provider to wire “/” focus, “Cmd/Ctrl+K” open/close.

## Interplay with Bottom Bar (BL-013A)

- Bottom Bar continues to show ephemeral status and minimal shortcuts (e.g., “Mode: Manual • Autosave: active (every 10s)”).
- Top Bar hosts the Prompt trigger button, while Bottom Bar advertises the “Shift+Tab” shortcut (and shows streaming state).
- When Suggestion streaming is active, Top Bar can show a discreet dot/badge near Prompt; Bottom Bar shows the full streaming line.

## Integration Plan

1) Add `TopBarProvider` and `TopBar` to `AppLayout`
- Wrap children with provider.
- Replace the current header markup with `<TopBar />` while preserving:
  - The “liriac” brand text for test stability.
  - Existing theme toggle (migrate into Top Bar).

2) Library route (`LibraryPage`)
- Publish:
  - breadcrumb: “Library”
  - showSearch: true
  - quickActions: `New Book`, (optional) `New Chapter` when a book is selected, `Reorder` when applicable.
  - contextChips: none by default.
  - promptEnabled: false

3) Editor route (`EditorPage`)
- Publish:
  - breadcrumb: “Book: ‹title or id› › Chapter: ‹n› ‹title›”
  - showSearch: true
  - quickActions: `New Chapter`, `Reorder`, `Edit` (chapter)
  - contextChips: Personas and Chapters counts (from existing context API later; mocked now)
  - promptEnabled: true
  - meta: words/reading time (computed from current content length for MVP)

4) Palette commands
- Register navigation items from cached lists (books, visible chapters).
- Register actions matching quick actions; duplicates prevented by `id`.

5) Connectivity & Env
- Implement a lightweight heartbeat for API (HEAD /api/v1/health/ mocked by flag).
- WS status derived from existing Channels usage later; mocked now.
- Render a “DEV” badge by default in dev/test.

6) Theming & A11y
- Tailwind variants for dark/light; header `role="banner"`, breadcrumbs labelled, palette as accessible dialog.

## Mocks & Placeholders (Dev/Test)

To avoid coupling to backend search and deep suggestion/context integration, ship frontend-only mocks guarded by a dev/test flag.

- Feature flag and scope:
  - Enabled when `import.meta.env.DEV === true` OR when `globalThis.VITE_ENABLE_TOPBAR_MOCKS !== false` (default true in dev/test).
  - In production builds, mocks are disabled (no timers/fake calls); Top Bar renders with real data when available.

- Mock data sources:
  - Books/Chapters: derive from React Query caches when present; otherwise seed with a tiny in-memory array for palette demos.
  - Connectivity: `setInterval` toggles `ws` between `connected` and `connecting` every 10–15s; `api` pings a no-op promise.
  - Doc meta: when on Editor, compute `words = content.trim().split(/\s+/).length` (guard empty) and `readingMinutes = Math.max(1, Math.round(words / 200))`; expose via `setMockDocMeta`.

- Exposed helpers (no-ops in prod):
  - `setMockConnectivity(status)`, `setMockDocMeta(meta)`.
  - `registerCommands([...])` with sample “Navigate” and “Actions”.

- A11y guarantees:
  - Palette remains a labelled dialog, keyboard navigable, ESC closable.
  - Tooltips and aria-labels for icons.

- Removal plan:
  - When BL-015/Context features land, replace mock derivations with real selectors and delete mock intervals.

## Implementation Tasks

- FE-1: Create `TopBarProvider` and `useTopBar()` hook (Context or Zustand).
- FE-2: Build `TopBar` UI (brand + breadcrumb, center search/palette entry, right actions/indicators).
- FE-3: Implement `CommandPalette` dialog with keyboard and item API.
- FE-4: Integrate Top Bar into `AppLayout` replacing current header markup; preserve “liriac” brand for tests.
- FE-5: Route integrations:
  - Library: publish breadcrumb, actions, search.
  - Editor: publish breadcrumb, actions, context chips, meta; compute words/reading time.
- FE-6: Connectivity/env badges (mocked in dev/test).
- FE-7: Tests:
  - Unit tests for provider and palette behaviors.
  - Integration tests ensuring brand (“liriac”) remains and palette opens via “Cmd/Ctrl+K”.
  - Route-level checks that breadcrumbs render correctly.
- FE-8: Docs: add README snippets for Top Bar usage; cross-link with BL-013A.

Estimates (rough):
- FE-1..FE-2: 1.5d
- FE-3: 1.0d
- FE-4..FE-5: 1.0d
- FE-6..FE-7: 0.5d
- Total: ~4.0d

## Acceptance Criteria

- Top Bar is visible on all pages, stuck to top; does not occlude content.
- Brand (“liriac”) remains visible; existing tests referencing it still pass.
- Library route:
  - Shows breadcrumb “Library”.
  - Search available; “/” focuses search or opens palette (compact).
  - Quick action: “New Book” visible; optional “New Chapter” when a book is selected.
- Editor route:
  - Prompt button visible; clicking opens prompt UI (or no-op when mocks disabled).
  - Context chips display counts (mocked in dev/test).
  - Meta displays words/reading time derived from content.
- Command palette:
  - Opens with “Cmd/Ctrl+K”, navigable by keyboard, ESC closes.
  - Contains at least one navigate item and one action.
- Connectivity/env badges:
  - DEV badge visible in dev/test; API/WS indicators update via mocks.
- A11y:
  - Header has appropriate landmarks; palette is an accessible dialog; all interactive elements have labels.

## Risks & Mitigations

- Header overcrowding on small screens:
  - Collapse to icons; keep search in palette; gate secondary indicators behind “…” menu.
- State duplication between Top/Bottom bars:
  - Clear ownership: persistent context in Top, ephemeral/streaming in Bottom.
- Palette growth and performance:
  - Lazy-register items per route; limit items to cached/current lists.

## Open Questions

- Should “/” always open the palette (even on desktop) instead of focusing an inline input?
- Do we include model/provider selector in MVP or defer to a follow-up?
- How do we surface notifications (toast vs. badge with dropdown) without adding complexity?

## Follow-ups

- BL-015: wire prompt and streaming state indicators (Top: small badge; Bottom: detailed stream line).
- Context modal integration from Top Bar context chips.
- Global shortcuts overlay (“?”) enumerating route-specific shortcuts.
- Persist palette recent items per session (optional).
