# BL-012C — Library: Chapter Creation & Editing

Status: Planned  
Last updated: 2025-09-20  
Owners: FE + BE  
Depends on: BL-012 (Library dashboard), BL-013 (Editor), BL-006 (Autosave), BL-009/BL-010 (OpenAPI & Types), BL-005 (DRF serializers)

## Summary

Add chapter creation and metadata editing to the Library dashboard. Users can:
- Create a new chapter under a selected book (Title + Order + optional initial Body).
- Edit an existing chapter’s Title and Order.
- Body changes happen in the Editor and persist via Autosave (BL-006); not in this dialog.
- After creation/update, the chapters list refreshes and (optionally) navigates to the created/edited chapter’s Editor route.

## Goals

- “New Chapter” action visible when a book is selected.
- Dialog UX for create/edit with accessible semantics and clear validation.
- Client computes the required checksum for creation from the provided (possibly empty) body.
- Preserve chapters pagination and ordering; optimistic selection/navigation flows.

## Non-Goals (This Ticket)

- Delete chapters, drag-and-drop reordering, or bulk renumbering.
- Editing chapter body via this dialog (handled by Editor + Autosave).
- Cross-book moves.

## UX Acceptance Criteria

- Chapters panel shows a “New Chapter” button when a book is selected.
- Create dialog (role="dialog", Esc closes, focus trapped):
  - Fields:
    - Title (required, trimmed)
    - Order (required, positive integer; client pre-fills with next available order)
    - Body (optional; defaults to empty string)
  - Client computes `checksum = sha256(body)` (hex-encoded, lowercase).
  - Actions: Create (primary), Cancel (secondary).
  - On submit:
    - Shows a busy state.
    - On success (201), chapters list refetches; optionally navigate to `/books/:bookId/chapters/:chapterId`.
    - Dialog closes and focus returns to a sensible target (list or editor).
  - Errors:
    - API field errors (e.g., duplicate order) render under inputs (`aria-live="polite"`).
    - Network errors show a non-intrusive message with “Retry”.
- Edit dialog for a chapter (entry-point via per-row action or overflow menu):
  - Pre-filled Title and Order; Body not present.
  - Submits PATCH; on success (200) updates list item and closes.
- Accessibility:
  - Dialog labeled by its heading via `aria-labelledby`; inputs have labels; keyboard navigation works with Tab/Shift+Tab.
  - Error messages are announced via `aria-live`.

## Backend Changes

- Endpoints already available:
  - Create: `POST /api/v1/books/{book_pk}/chapters/` (returns `ChapterList` shape).
  - Update (metadata only): `PATCH /api/v1/chapters/{id}/` (returns `ChapterDetail`).
    - Server forbids `body`/`checksum` changes on PATCH (by design).
  - Body updates: `POST /api/v1/chapters/{id}/autosave/` (BL-006).
- Validation:
  - `ChapterCreateSerializer.validate_checksum` enforces 64-hex format.
  - DB constraint enforces `(book, order)` uniqueness.
- Schema:
  - Operations are present in OpenAPI (no changes needed).
- Tests (already cover core behavior); keep stable.

## Frontend Changes

- API (`src/api/endpoints.ts`):
  - `createChapter(bookId: number, payload: { title: string; order: number; body?: string; checksum: string })`
  - `updateChapter(id: number, payload: { title?: string; order?: number })` (PATCH)
- Hashing helper (browser):
  - Use Web Crypto API; example TypeScript:
    ```
    export async function sha256Hex(input: string): Promise<string> {
      const encoder = new TextEncoder();
      const data = encoder.encode(input);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    ```
- UI:
  - Add “New Chapter” button to Chapters panel header (enabled when a book is selected).
  - `ChapterDialog` component:
    - Props: `mode: 'create' | 'edit'`, `initial?: { title: string; order: number; body?: string }`, `onSuccess`, `onClose`.
    - Create mode: includes Body textarea; computes checksum on submit.
    - Edit mode: Title + Order only.
  - Integrate into `ChaptersList` (per-row Edit action) and `LibraryPage` (create flow).
  - On create success:
    - Invalidate `['books', bookId, 'chapters', params]` or targeted update.
    - Optionally navigate to the new chapter’s Editor route.
  - On edit success:
    - Update list cache entry in place; preserve pagination and scroll.
- Validation & Errors:
  - Title required (trim), Order positive integer.
  - Surface server errors (e.g., order uniqueness) under respective fields.

## Testing

- Frontend (Vitest + RTL):
  - Dialog open/close, keyboard (Esc), focus trapping.
  - Create: validates empty/invalid fields; computes checksum; mutation success updates list and navigates (when enabled).
  - Edit: updates title/order only; PATCH called with expected payload.
  - Error handling: duplicate order (400) shows inline errors; network failure shows retry affordance.
- Contract:
  - Ensure OpenAPI-derived types align (no drift); `make contract-check`.
- CI:
  - Lint, typecheck, and tests pass.

## Rollout & Migration

- No DB migrations.
- Backward compatible; new UI only.

## Edge Cases

- Duplicate order within a book → 400; keep dialog open with inline message.
- Creating while a search filter is active → the new chapter may not appear in filtered view; still navigate/announce success.
- Rapid double submit → disable primary action while request is in flight.
- Empty body on create → compute checksum of empty string to satisfy backend.

## Open Questions

- Should “navigate to editor after create” be default or optional (checkbox)?
- Do we auto-increment order gaps on edit or leave sparse numbering? (MVP: leave as provided.)
- Do we allow renumbering to 0 or negative? (MVP: client prevents; server requires positive int.)

## Implementation Tasks

- Frontend
  - Add `createChapter` and `updateChapter` endpoints + hashing helper.
  - Build `ChapterDialog` (create/edit).
  - Wire “New Chapter” and per-row “Edit” actions.
  - React Query mutations + cache updates + optional navigation.
  - Tests for dialog behaviors, validation, success/error flows.
- Backend
  - No changes expected.
- Contracts & Tooling
  - `make contract-check`
- Docs
  - Link from BL-012 and Editor/Autosave docs as relevant.

## API Examples

- Create
  - Request: `POST /api/v1/books/42/chapters/`
    ```
    { "title": "Chapter 7", "order": 7, "body": "", "checksum": "<sha256-of-body>" }
    ```
  - Response: `201`
    ```
    { "id": 123, "title": "Chapter 7", "order": 7, "updated_at": "..." }
    ```
- Edit (metadata)
  - Request: `PATCH /api/v1/chapters/123/`
    ```
    { "title": "Chapter 7 — Revised", "order": 8 }
    ```
  - Response: `200` (ChapterDetail)

## References

- Backend
  - `backend/apps/library/api/views.py` (BookChapterListCreateAPIView, ChapterViewSet)
  - `backend/apps/library/api/serializers.py` (ChapterCreateSerializer, ChapterDetailSerializer)
- Frontend
  - `frontend/src/features/library/ChaptersList.tsx`, `frontend/src/app/pages/LibraryPage.tsx`
  - `frontend/src/features/editor/hooks.ts`, `frontend/src/app/pages/EditorPage.tsx` (body editing via autosave)
- Backlog
  - `docs/02-backlog.md` (BL-012, BL-006)
