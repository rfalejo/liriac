# BL-012D — Library: Drag-and-Drop Chapter Ordering

Status: Planned  
Last updated: 2025-09-20  
Owners: FE + BE  
Depends on: BL-012 (Library dashboard), BL-012C (Chapter creation & editing), BL-006 (Autosave), BL-009/BL-010 (OpenAPI & Types), BL-005 (DRF serializers)

## Summary

Replace numeric “Order” inputs with drag-and-drop reordering for chapters. Creating a new chapter no longer asks for an order (or body) in the dialog — the chapter is appended to the end of the book. Ordering is managed via a DnD list in the Chapters panel with keyboard-accessible controls.

This supersedes parts of BL-012C:
- Remove “Order” field from create/edit dialogs.
- Remove “Body (optional)” from the create dialog; new chapters start empty and are edited in the Editor (Autosave handles persistence).

## Goals

- Drag-and-drop (and keyboard-accessible) reordering of chapters within a book.
- Creating a chapter appends it to the end (server computes next order).
- Dialog simplification:
  - Create: Title only (required).
  - Edit: Title only (required).
- Keep pagination/search stable and update ordering efficiently.
- Optimistic UI for reorder with graceful rollback on error.

## Non-Goals

- Cross-book moves (dragging across books is out of scope).
- Bulk renumbering beyond DnD interactions.
- Body editing outside the Editor (Autosave continues to own body changes).
- Delete/duplicate chapters (future tickets).

## UX Acceptance Criteria

- Chapters panel displays a list with drag handles:
  - Pointer: drag handle shows on hover/focus; dragging updates visual order.
  - Keyboard: focused item can move up/down (e.g., Alt+Arrow or dedicated buttons), with live region announcing changes.
- Create flow:
  - “New Chapter” opens a modal (role="dialog") with:
    - Title (required).
  - No “Order” input.
  - No “Body” input; new chapter body is empty.
  - On submit (201), list refreshes; new item appears at the end; optionally navigate to its Editor route.
- Edit flow:
  - “Edit” opens the same modal with Title only.
  - On submit (200), list reflects updated title.
- Accessibility:
  - Dialog is labeled (`aria-labelledby`) and described (`aria-describedby`).
  - Drag handles are focusable; keyboard moves are announced via `aria-live="polite"`.
  - Reorder actions are undoable (press Esc during drag cancels; failed server update rolls back).

## Backend Changes

- Create chapter defaults to last position:
  - Make `order` optional on create. If not provided, compute `order = (max(order) for book) + 1` inside `transaction.atomic`.
  - Enforce via server (ignore/normalize client-provided order if present, or reject it to keep API simple).
- Reorder endpoint (batch update):
  - Route: `POST /api/v1/books/{book_pk}/chapters/reorder/`
  - Payload:
    ```
    { "ordered_ids": [3, 10, 5, 7, ...] }  // all chapter IDs for that book in desired order
    ```
  - Behavior:
    - Validate that `ordered_ids` contains exactly the set of chapters for the given book (no extras/missing).
    - Update `order` to 1..N in a single transaction, using `select_for_update` to avoid races.
    - Return 200 with the updated list (or 204).
  - Errors:
    - 400 on mismatched IDs, duplicates, or cross-book IDs.
- OpenAPI/Schema:
  - Update schema to:
    - Make `order` optional/omitted in ChapterCreate.
    - Add `books_chapters_reorder` operation.
- Logging:
  - Info-level logs for reorder actions (book_id, count, duration).

## Frontend Changes

- Remove “Order” and “Body” fields from ChapterDialog:
  - Create: Title only; submit with `body = ""`, `checksum = sha256("")`.
  - Edit: Title only.
- Chapters list supports drag-and-drop:
  - Use a11y-friendly DnD (e.g., `@dnd-kit/core`) or accessible keyboard controls fallback.
  - On drop or keyboard move:
    - Compute new ordering, call reorder endpoint optimistically.
    - If API fails, revert to previous order and show an inline error.
- React Query:
  - Continue to page/search; on successful reorder, update cached lists consistently.
  - Consider a lightweight cache shape storing a stable, ordered array to avoid flicker across pages.
- Tests (Vitest + RTL):
  - Dialog tests updated (no Order/Body fields).
  - DnD tests:
    - Simulate pointer drag or invoke move handlers directly.
    - Verify payload (`ordered_ids`) and optimistic UI behavior.
    - Keyboard move tests with ARIA announcements.

## Testing (Backend)

- Create without order:
  - POST create without `order` → 201 and chapter has last `order`.
- Reorder endpoint:
  - Happy path: reordered IDs persisted; unique per book; sequential 1..N.
  - Validation failures: missing/extra/foreign IDs → 400.
  - Concurrency: two reorder attempts in parallel keep data consistent (atomic).
- Existing list/detail behavior unchanged.

## Rollout & Migration

- No DB migrations.
- Backward compatible for clients that omit `order` (recommended). If any client still sends `order`, decide to ignore or 400 — document chosen behavior.
- Add OpenAPI and regenerate frontend types; update CI contract checks.

## Edge Cases

- Reordering while a filter/search is applied:
  - Reorder the entire book’s sequence (not just the visible subset). The UI performs local visual reorder, but sends full set of IDs to the server.
- Pagination:
  - DnD across pages is out of scope in MVP. If attempted, show a tooltip: “Reorder within the current page; cross-page moves coming soon.”
- Duplicate titles allowed; order enforces chapter sequence.
- Large books (many chapters): consider virtualized list; ensure reorder remains responsive.

## Open Questions

- Library choice for DnD: `@dnd-kit/core` vs native pointer + custom keyboard helpers?
- Server behavior for client-sent `order` on create: ignore vs reject?
- Reorder response shape: return updated `ChapterList[]` vs 204 + client refetch?
- Cross-page DnD: defer or implement now with a “staging area”?

## Implementation Tasks

- Backend
  - Chapter create: make `order` optional; compute last+1 in `BookChapterListCreateAPIView.post` under `transaction.atomic`.
  - Add `POST /api/v1/books/{book_pk}/chapters/reorder/` view:
    - Validate IDs, lock rows, renumber 1..N, save in batch.
  - Update serializers/OpenAPI and tests.
- Frontend
  - Update `ChapterDialog`: Title-only create/edit; remove Order/Body fields and associated tests.
  - Add DnD in `ChaptersList` with accessible controls and optimistic mutation to reorder endpoint.
  - Update React Query cache on success; rollback on failure; adjust tests.
- Contracts & Tooling
  - `make schema fe-typegen`
  - `make contract-check`
- Docs
  - Reference this ticket from BL-012/BL-012C and update any UI screenshots/specs.

## API Examples

- Create (no `order`, empty body):
  - Request: `POST /api/v1/books/42/chapters/`
    ```
    { "title": "New Chapter", "body": "", "checksum": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855" }
    ```
  - Response: `201`
    ```
    { "id": 123, "title": "New Chapter", "order": 17, "updated_at": "..." }
    ```
- Reorder:
  - Request: `POST /api/v1/books/42/chapters/reorder/`
    ```
    { "ordered_ids": [5, 7, 2, 9] }
    ```
  - Response: `200`
    ```
    { "results": [
      { "id": 5, "order": 1 }, { "id": 7, "order": 2 }, { "id": 2, "order": 3 }, { "id": 9, "order": 4 }
    ] }
    ```

## References

- BL-012C: `docs/tickets/BL-012C.md`
- Backend: `backend/apps/library/api/views.py`, `backend/apps/library/api/serializers.py`
- Frontend: `frontend/src/features/library/ChaptersList.tsx`, `frontend/src/features/library/components/ChapterDialog.tsx`
- Autosave: `docs/00-draft.md` (Manual Writing Mode), BL-006
