# Ticket BL-012: Context Management — Chapters/Personas Selection and Token Estimate

## Description
Add a Context Management feature to let users choose which chapters and personas to include in AI context, set a system prompt, and see an approximate token estimate before generation. This introduces a minimal services layer for context selection and estimation, expands the typed `ContextProfile` to carry selected references, and provides a dedicated Textual screen to toggle items. No network calls are performed; token estimation uses a simple heuristic (characters-to-tokens) and filesystem reads via the existing repository.

Scope:
- Extend domain type `ContextProfile` to include selected chapters, personas, and a system prompt.
- Services: lightweight helpers to manage selection and estimate tokens using a heuristic and `ChapterRepository` reads.
- TUI: a `ContextScreen` that lists chapters and personas (if any) with toggle controls, editable system prompt, and an action to apply/commit the context.
- App integration: open the Context screen from the app and receive a typed message with the committed `ContextProfile`.
- Strict typing, no implicit `Any`, no new dependencies.

Out of scope:
- Advanced budgeting, multi-retry strategies, or integration with AI provider.
- Persisting context state to disk (UI state persistence is a later ticket).
- Accurate tokenization via `tiktoken` (can be introduced later).

## Acceptance Criteria
- Domain Types:
  - `src/liriac/domain/types.py`:
    - Update `ContextProfile` to:
      - `chapters: tuple[ChapterRef, ...]`
      - `personas: tuple[PersonaRef, ...]`
      - `system_prompt: str`
    - Fully annotated; keep `__all__` updated; no implicit `Any`.
  - Backwards-compatibility: existing tests importing `ContextProfile` must still pass after minor updates (new fields are required).

- Services — Context:
  - New modules:
    - `src/liriac/services/context/selectors.py`:
      - `@dataclass(slots=True) class SelectionState` with:
        - `selected_chapters: set[ChapterRef]`
        - `selected_personas: set[PersonaRef]`
      - Methods: `toggle_chapter(ref)`, `toggle_persona(ref)`, `clear()`, `snapshot() -> tuple[tuple[ChapterRef, ...], tuple[PersonaRef, ...]]`.
    - `src/liriac/services/context/builder.py`:
      - `def build_context(*, chapters: tuple[ChapterRef, ...], personas: tuple[PersonaRef, ...], system_prompt: str) -> ContextProfile`
      - Pure function; no IO; returns immutable `ContextProfile`.
    - `src/liriac/services/context/limits.py`:
      - `def estimate_tokens(text: str) -> int`: simple heuristic (e.g., `max(1, round(len(text) / 4))`).
      - `def estimate_profile_tokens(library_path: Path, repo: ChapterRepository, profile: ContextProfile) -> int`:
        - Reads included chapters via `repo.read_chapter(...)`, sums chapter texts + system prompt, returns `estimate_tokens(total_text)`.
      - Fully annotated; no network calls; tolerate empty personas.
  - `src/liriac/services/context/__init__.py` exports `SelectionState`, `build_context`, and `estimate_profile_tokens`.

- TUI — Context Screen:
  - `src/liriac/tui/screens/context/view.py`:
    - `class ContextCommitted(Message)` with `profile: ContextProfile`.
    - `class ContextScreen(Screen)`:
      - Constructor args: `library_path: Path`, `repo: LibraryRepository & ChapterRepository` (single instance is acceptable), optional initial `system_prompt: str`.
      - On mount:
        - Lists available books and, upon selection, shows chapters with toggles.
        - Shows personas panel; when none, displays “No personas found” placeholder.
        - Editable `system_prompt` input field.
      - Bindings:
        - Up/Down: navigate items in focused list.
        - Tab/Shift+Tab: switch focus between panels (books/chapters/personas/prompt).
        - Space: toggle selected chapter/persona checkbox.
        - `s` or `ctrl+s`: commit current selection by posting `ContextCommitted(profile)`.
        - `escape`: return to the previous screen without committing.
      - Visuals: minimal; no styling requirements beyond existing project defaults.
    - Fully annotated; no implicit `Any`; no network/writes.
  - `src/liriac/tui/__init__.py` re-exports `ContextScreen` and `ContextCommitted`.
  - App integration:
    - `src/liriac/app.py`:
      - Key binding: pressing `c` opens `ContextScreen(library_path, repo)`.
      - Handler: `on_context_committed(message: ContextCommitted)` stores `self.last_context_profile: ContextProfile | None`.
    - Import succeeds in tests; screen can be opened and closed without errors.

- Behavior:
  - Works with existing filesystem repository; Personas list is empty unless added in future tickets; the UI handles empty personas gracefully.
  - Token estimate is visible internally via service API; TUI may optionally display the integer estimate in a footer/status label (not required).
  - No disk writes (apart from chapter reads for estimation).

- Packaging and Tooling:
  - No new runtime dependencies.
  - `mypy --strict` passes.
  - `ruff` and `black` pass after initial format.

- Tests:
  - Services:
    - `tests/services/test_context.py`:
      - `SelectionState` toggling and snapshot behavior.
      - `build_context` returns immutable `ContextProfile`.
      - `estimate_tokens` heuristic basics and stability.
      - `estimate_profile_tokens` with a temp library + repo: sums selected chapters + system prompt.
  - TUI:
    - `tests/tui/test_context.py`:
      - Import `ContextScreen` and `ContextCommitted`.
      - With a temp library containing 1–2 books and chapters:
        - Open `ContextScreen` via `LiriacApp.run_test()`; ensure books list populates.
        - Navigate to chapters list, toggle at least one chapter with Space; optional personas gracefully shows “No personas found”.
        - Enter/edit a short system prompt.
        - Press `s` to commit and assert the app receives `ContextCommitted` and stores `last_context_profile`.
      - `escape` returns to previous screen without committing (no crash).
  - All tests avoid network calls and pass on Linux.

## Testing Strategy
- Services:
  - Unit test `SelectionState`:
    - Toggling add/remove semantics, clearing state, snapshot immutability.
  - Unit test `build_context`:
    - Ensures returned `ContextProfile` contains tuples and the system prompt as provided.
  - Integration-like test for `estimate_profile_tokens`:
    - Create a temp library with chapter files; use `FilesystemLibraryRepository` and select chapters; assert estimated tokens increase with content and include `system_prompt`.
- TUI (Textual Pilot):
  - Launch `LiriacApp(tmp_library)`; push `ContextScreen`.
  - Verify:
    - Books list loads; selecting a book populates chapters.
    - Space toggles chapter items.
    - Tab navigates panels; prompt is editable.
    - `s` posts `ContextCommitted` and app records `last_context_profile`.
    - `escape` returns to previous screen.
- Quality gates:
  - `make fmt`, `make lint`, `make typecheck`, and `make test` all succeed with new modules and tests.
