# BL-005 — DRF serializers/viewsets for Books, Chapters, Personas

Status: Planned  
Owner: TBA  
Labels: backend, api, drf, pagination, filtering, validation  
Blocks: none  
Depends on: BL-004 (models)

## Summary
Expose REST endpoints for books, chapters, and personas using Django REST Framework. Provide list/create for top-level collections, nested chapter listing under a book, chapter detail + partial update, and standard pagination, filtering, ordering, and validation. Generate OpenAPI and update frontend TypeScript types.

## Goals
- Implement DRF serializers and viewsets for:
  - Books: list, retrieve, create.
  - Chapters: list (by book), create (under book), retrieve, partial update (title/order only).
  - Personas: list, retrieve, create, optional partial update (role/notes).
- Support pagination (page size 20 via settings), search filtering, and ordering.
- Enforce model validations (unique slug for books, unique name for personas, checksum format for chapters).
- Produce OpenAPI via DRF Spectacular and regenerate frontend DTO types.

## Non-Goals
- Autosave endpoints or logic (covered in BL-006).
- Suggestions endpoints/streaming (covered in BL-007/BL-008/BL-015).
- Authentication/authorization (MVP is local-only).
- Deletion endpoints.

## API Surface
Base: `/api/v1/`

- Books
  - `GET /books/` — list books (paginated; search by `title`/`slug`; order by `title`,`created_at`).
  - `POST /books/` — create book.
  - `GET /books/{book_id}/` — retrieve book.
- Chapters
  - `GET /books/{book_id}/chapters/` — list chapters for a book (paginated; search by `title`; order by `order`,`updated_at`).
  - `POST /books/{book_id}/chapters/` — create chapter in book.
  - `GET /chapters/{chapter_id}/` — retrieve chapter with `body` and `checksum`.
  - `PATCH /chapters/{chapter_id}/` — partial update for `title` and `order` only (no `body`/`checksum` changes in this ticket).
- Personas
  - `GET /personas/` — list personas (paginated; search by `name`/`role`; order by `name`).
  - `POST /personas/` — create persona.
  - `GET /personas/{persona_id}/` — retrieve persona.
  - `PATCH /personas/{persona_id}/` — partial update for `role` and `notes`.

## Schemas (shapes)
- Book
  - List/Detail response: `{ id, title, slug, created_at, last_opened }`
  - Create request: `{ title: str, slug: str }`
- Chapter
  - List item (under book): `{ id, title, order, updated_at }`
  - Detail response: `{ id, book, title, order, body, checksum, created_at, updated_at }`
  - Create request (under book): `{ title: str, order: int, body: str, checksum: str }`
  - Patch request: `{ title?: str, order?: int }` (reject `body`/`checksum` changes)
- Persona
  - List/Detail response: `{ id, name, role, notes, created_at }`
  - Create request: `{ name: str, role?: str, notes?: str }`
  - Patch request: `{ role?: str, notes?: str }`

## Validation
- Book.slug: required, unique; server normalizes to slug format (model already slugifies).
- Persona.name: required, unique.
- Chapter.checksum: hex SHA-256 regex `^[0-9a-f]{64}$` (mirror model validator in serializer).
- Chapter.order: positive integer; uniqueness per book enforced at DB; duplicate should return 400 with serializer/DB error mapping.
- Chapter PATCH: reject attempts to modify `body` or `checksum` (serializer `validate`).

## Filtering, Search, Ordering, Pagination
- Pagination: DRF PageNumberPagination (already configured), response keys: `count`, `next`, `previous`, `results`.
- Search:
  - Books: `?search=foo` over `title`, `slug`.
  - Chapters: `?search=foo` over `title` (on book’s chapters listing).
  - Personas: `?search=foo` over `name`, `role`.
- Ordering:
  - Books: `?ordering=title` or `-created_at`.
  - Chapters: `?ordering=order` or `-updated_at`.
  - Personas: `?ordering=name`.
- Filtering context for chapters via path: only chapters for the specified `book_id` should be listed/created.

## Error Handling
- Standard DRF validation errors: 400 with field-level messages.
- Not found: 404 for missing resources.
- Method not allowed: default 405 for unsupported verbs (e.g., POST on `/api/v1/chapters/{id}/`).
- Unique constraint violations surfaced as 400 with appropriate field messages.

## OpenAPI & Types
- Tag endpoints as `books`, `chapters`, and `personas`.
- Run `make schema` to regenerate `backend/schema.yaml`.
- Run `make fe-typegen` to refresh `frontend/src/api/types.ts`.

## Implementation Plan
- Serializers (`apps/library/api/serializers.py`):
  - `BookSerializer`
  - `ChapterListSerializer` and `ChapterDetailSerializer`
  - `PersonaSerializer`
- ViewSets/Views (`apps/library/api/views.py`):
  - `BookViewSet` (list, retrieve, create) with `SearchFilter`, `OrderingFilter`.
  - `PersonaViewSet` (list, retrieve, create, partial_update) with `SearchFilter`, `OrderingFilter`.
  - `ChapterViewSet` (retrieve, partial_update).
  - `BookChapterViewSet` or `BookChaptersView` (list/create scoped to `book_id`).
- URLs
  - Router under `apps.library` for `/books/`, `/chapters/`, `/personas/`.
  - Manual path for `/books/{book_id}/chapters/` (list/create).
  - Include at `path('api/v1/', include('apps.library.api.urls'))` in `liriac/urls.py`.
- Filtering/Ordering
  - Enable `SearchFilter` and `OrderingFilter` either via viewsets or DRF settings.
- Validation
  - Serializer-level validation for checksum format and PATCH field restrictions.
- Tests (pytest; new files in `backend/tests/`)
  - `test_api_books.py`
    - list (paginated), create (201), retrieve (200), search and ordering.
    - slug uniqueness returns 400.
  - `test_api_chapters.py`
    - list under book (only that book’s chapters), create (201), retrieve (200), patch title/order (200).
    - ensure list excludes `body`/`checksum`, detail includes them.
    - invalid checksum on create returns 400; duplicate order within book returns 400.
    - search and ordering on list.
  - `test_api_personas.py`
    - list (paginated), create (201), retrieve (200), patch (200).
    - name uniqueness returns 400; search and ordering covered.
- Docs
  - Brief endpoint notes in `docs/00-draft.md` or a new `docs/api.md` (optional).
- Tooling
  - Ensure ruff/black and mypy strict pass.
  - Regenerate OpenAPI and TS types.

## Acceptance Criteria
- All endpoints above respond with expected shapes and status codes.
- Pagination (`count`, `next`, `previous`, `results`) present on list endpoints.
- Search (`?search=`) and ordering (`?ordering=`) work for books, chapters (by book), and personas.
- Chapter detail includes `body` and `checksum`; book-scoped chapter list excludes these fields.
- Validation errors returned for:
  - duplicate `slug` on books,
  - duplicate `name` on personas,
  - invalid `checksum` or duplicate `order` within a book for chapters,
  - attempts to PATCH `body`/`checksum` on chapter.
- `make check` passes (lint, typecheck, tests) and OpenAPI/types are up to date.

## Request/Response Examples

- Create Book
```
POST /api/v1/books/
{ "title": "El viajero", "slug": "el-viajero" }

201
{ "id": 1, "title": "El viajero", "slug": "el-viajero", "created_at": "...", "last_opened": null }
```

- List Chapters for Book
```
GET /api/v1/books/1/chapters/?ordering=order

200
{
  "count": 2,
  "next": null,
  "previous": null,
  "results": [
    { "id": 10, "title": "Cap 01", "order": 1, "updated_at": "..." },
    { "id": 11, "title": "Cap 02", "order": 2, "updated_at": "..." }
  ]
}
```

- Chapter Detail
```
GET /api/v1/chapters/10/

200
{
  "id": 10,
  "book": 1,
  "title": "Cap 01",
  "order": 1,
  "body": "The pier smelled of salt...",
  "checksum": "a3f4...d9c0",
  "created_at": "...",
  "updated_at": "..."
}
```

- Patch Chapter (title/order only)
```
PATCH /api/v1/chapters/10/
{ "title": "Cap 01 — Revised", "order": 1 }

200
{ "id": 10, "book": 1, "title": "Cap 01 — Revised", "order": 1, "body": "...", "checksum": "...", "created_at": "...", "updated_at": "..." }
```

- Create Chapter (under book)
```
POST /api/v1/books/1/chapters/
{ "title": "Cap 03", "order": 3, "body": "Text", "checksum": "<64-hex>" }

201
{ "id": 12, "title": "Cap 03", "order": 3, "updated_at": "..." }
```

- Persona Search
```
GET /api/v1/personas/?search=protagonist&ordering=name

200
{
  "count": 1,
  "next": null,
  "previous": null,
  "results": [
    { "id": 5, "name": "Camila", "role": "protagonist", "notes": "", "created_at": "..." }
  ]
}
```

## Risks & Mitigations
- Nested routing complexity: use a simple view for `/books/{id}/chapters/` rather than heavy nested routers.
- Schema drift: enforce `make schema` and `make fe-typegen` in PR.
- Large payloads: exclude `body`/`checksum` from chapter list to keep responses small.

## Estimation
- Effort: M (2–3 days including tests and docs).

## Checklist
- [ ] Serializers implemented with validations.
- [ ] Viewsets and routes registered.
- [ ] Search/ordering configured.
- [ ] Tests for books/chapters/personas passing.
- [ ] OpenAPI regenerated; TS types updated.
- [ ] Lint/format/typecheck clean.
