# Ticket BL-005: Configuration Settings Adapter (Env + Config File)

## Description
Introduce a typed configuration adapter that loads application settings with strict precedence and validation. Implement a small Infra module to read `~/.config/liriac/config.toml` (or `$XDG_CONFIG_HOME/liriac/config.toml`), layer environment variables, and finally apply optional CLI overrides. Use Pydantic models for type safety and validation. No network calls and no writes are performed by this ticket.

Configuration precedence:
1) CLI overrides → 2) Environment variables → 3) Config file → 4) Defaults.

Scope:
- Define a typed `AppSettings` model (Pydantic) with key fields used across the app and upcoming features.
- Implement file discovery and TOML parsing for a single config file.
- Merge dictionaries in the defined precedence order.
- Provide a single `load_settings()` entry point to obtain validated settings.
- Keep the module self-contained in Infra, independent from the TUI/CLI aside from optional overrides mapping.

Out of scope:
- Refactoring CLI to consume settings (may be wired later).
- Any AI provider network usage.
- Persisting or writing configuration files.

## Acceptance Criteria
- Infra module:
  - `src/liriac/infra/config/settings.py` implements:
    - `AppSettings` (Pydantic `BaseModel`) with fields:
      - `library_path: Path` (default: `Path.cwd()`; not validated to exist here).
      - `ai_provider: Literal["openai"] | None` (default: `"openai"`).
      - `openai_api_key: str | None` (default: `None`).
      - `openai_model: str` (default: `"gpt-4"`).
      - `openai_base_url: str | None` (default: `None`).
      - `openai_max_tokens: int` (default: `512`, must be > 0).
      - `openai_request_timeout: int` (seconds, default: `120`, must be > 0).
    - Validators:
      - Positive integers for `openai_max_tokens` and `openai_request_timeout`.
      - Normalize `library_path` to absolute via `.resolve()` in a model validator.
    - `get_default_config_path() -> Path`:
      - Uses `$XDG_CONFIG_HOME/liriac/config.toml` when set; otherwise `~/.config/liriac/config.toml`.
    - `read_config_file(path: Path | None = None) -> dict[str, object]`:
      - Returns `{}` if file does not exist.
      - Parses TOML via `tomllib`; raises `ValueError` with a concise message on invalid TOML.
    - `load_settings(cli_overrides: dict[str, object] | None = None) -> AppSettings`:
      - Loads config from file and environment, then applies CLI overrides last.
      - Environment variable mapping (all optional):
        - `LIRIAC_LIBRARY_DIR` → `library_path`
        - `LIRIAC_AI_PROVIDER` → `ai_provider`
        - `OPENAI_API_KEY` → `openai_api_key`
        - `OPENAI_MODEL` → `openai_model`
        - `OPENAI_BASE_URL` → `openai_base_url`
        - `OPENAI_MAX_TOKENS` → `openai_max_tokens` (int)
        - `OPENAI_REQUEST_TIMEOUT` → `openai_request_timeout` (int)
      - Unknown keys in config file are ignored safely.
  - `src/liriac/infra/config/__init__.py` exposes `AppSettings`, `load_settings`, and helpers via `__all__`.

- Packaging:
  - `pyproject.toml`:
    - Add runtime dependency `pydantic>=2.5`.
    - Keep existing tooling and strict typing intact.

- Typing and style:
  - Code is fully annotated; `mypy --strict` passes with zero errors.
  - `ruff` and `black` pass without changes after initial format.
  - No network or disk writes; only reads a single TOML file when present.

- Tests:
  - Add `tests/infra/test_settings.py` covering:
    - Default load: no env, no file → `AppSettings()` values equal defaults.
    - File-only: write a minimal TOML under a temp `$XDG_CONFIG_HOME` → values reflect file.
    - Env-only: set env vars → values reflect env and types are coerced (ints).
    - Precedence: when file + env + CLI overrides are provided, CLI wins over env, env wins over file.
    - Invalid TOML raises `ValueError` with a concise message.
    - Validation: negative `openai_max_tokens` or `openai_request_timeout` via env/file → validation error.
    - `library_path` is resolved to an absolute path but not required to exist.

- Quality gates:
  - `make fmt` yields no changes after the initial run.
  - `make lint` passes cleanly.
  - `make typecheck` passes with `mypy --strict`.
  - `make test` passes and executes new tests.

## Testing Strategy
- Unit tests with pytest:
  - Use `monkeypatch` to set `XDG_CONFIG_HOME` to a temp directory and to set/unset environment variables.
  - Use `tmp_path` to create a fake config directory and TOML file.
  - Validate precedence matrix:
    - File < Env < CLI overrides for overlapping keys.
  - Validate parsing:
    - Example `config.toml`:
      ```toml
      library_path = "projects/books"
      ai_provider = "openai"
      openai_model = "gpt-4o-mini"
      openai_max_tokens = 1024
      openai_request_timeout = 90
      ```
  - Validate data types and validators:
    - `openai_max_tokens = -1` or `openai_request_timeout = 0` → error.
    - Paths become absolute after loading.
- No integration with the CLI/TUI loop in this ticket; only import and call the loader in tests.
```