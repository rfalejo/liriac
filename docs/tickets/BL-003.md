# Ticket BL-003: Domain Entities and Core Types

## Description
Introduce the first set of pure Domain entities and core types to model books, chapters, personas, suggestions, and context selection. These structures are strictly typed, immutable where appropriate, contain no IO or thirdâ€‘party dependencies, and enforce basic invariants via validation. They will be the foundation for services and infrastructure added in subsequent tickets.

Scope:
- Add strongly typed IDs with `NewType` and shared literals/enums for constrained fields.
- Define immutable value objects for references used across the domain.
- Implement core entities as frozen dataclasses with invariant checks, free of side effects and IO.
- Keep field collections immutable (`tuple`) and use pathlib pure paths for references.
- Provide concise, discoverable module layout and `__all__` exports for clarity.

Out of scope:
- Ports/Protocols for repositories and AI providers (introduced in later tickets).
- Persistence, filesystem access, or Textual UI integration.
- Services/use-cases and business workflows.
- Any network or disk IO.

## Acceptance Criteria
- Source layout:
  - `src/liriac/domain/__init__.py` exports public symbols of the Domain layer.
  - `src/liriac/domain/types.py` defines:
    - `BookId`, `ChapterId`, `PersonaId`, `SuggestionId` as `NewType[str]`.
    - `SuggestionStatus` = `Literal["pending", "accepted", "rejected"]`.
    - `SuggestionSource` = `Literal["ai", "user"]`.
  - `src/liriac/domain/value_objects.py` defines immutable value objects:
    - `ChapterRef`: `book_id: BookId`, `relative_path: PurePosixPath` (no IO).
    - `PersonaRef`: `book_id: BookId`, `persona_id: PersonaId`.
    - Validation: non-empty IDs; `relative_path` must be relative (no anchor, no drive).
  - `src/liriac/domain/entities/book.py` defines frozen dataclass `Book`:
    - Fields: `id: BookId`, `title: str`, `created_at: datetime`, `chapters: tuple[ChapterRef, ...]`, `personas: tuple["Persona", ...]`.
    - Validation: non-empty title; `created_at` timezone-aware (`tzinfo is not None`).
  - `src/liriac/domain/entities/chapter.py` defines frozen dataclass `Chapter`:
    - Fields: `id: ChapterId`, `title: str`, `ref: ChapterRef`, `text: str`, `updated_at: datetime`.
    - Validation: non-empty title; `updated_at` timezone-aware.
  - `src/liriac/domain/entities/persona.py` defines frozen dataclass `Persona`:
    - Fields: `id: PersonaId`, `name: str`, `role: str | None`, `notes: str | None`, `enabled: bool`.
    - Validation: non-empty `name`; strip whitespace on `name`/`role`.
  - `src/liriac/domain/entities/suggestion.py` defines frozen dataclass `Suggestion`:
    - Fields: `id: SuggestionId`, `text: str`, `source: SuggestionSource`, `created_at: datetime`, `status: SuggestionStatus`.
    - Validation: non-empty `text`; `created_at` timezone-aware; `status` literal constraint.
  - All entity collection fields use `tuple[...]` to ensure immutability as per conventions.
  - Each module includes useful `__all__` declarations and docstrings.
- Typing and style:
  - Code passes `mypy --strict` with zero errors.
  - `ruff` and `black` pass without changes after initial format.
- Tests:
  - Add `tests/domain/test_types_and_values.py`:
    - Verifies `NewType` IDs behave as strings; cannot be empty in value objects.
    - Validates `ChapterRef` enforces a relative `PurePosixPath` and rejects absolute paths.
  - Add `tests/domain/test_entities.py`:
    - Constructs valid instances of `Book`, `Chapter`, `Persona`, `Suggestion`.
    - Asserts immutability (attribute assignment raises `FrozenInstanceError`).
    - Asserts validation errors on empty titles/names or naive datetimes.
    - Verifies tuple semantics for collection fields.
  - Tests contain no filesystem or network IO.
- Tooling:
  - `make fmt`, `make lint`, `make typecheck`, and `make test` all succeed.

## Testing Strategy
- Types and Value Objects:
  - Instantiate each `NewType` and ensure they round-trip as strings.
  - `ChapterRef`: accept `PurePosixPath("chapters/01.md")`; reject absolute or anchored paths (e.g., `/chapters/01.md`).
  - `PersonaRef`: verify non-empty `BookId` and `PersonaId`.
- Entities:
  - Happy-path construction for `Book`, `Chapter`, `Persona`, `Suggestion`; assert fields, types, and tuple collections.
  - Invariant checks:
    - Empty `title`/`name` raises `ValueError`.
    - Naive `datetime` (no `tzinfo`) raises `ValueError`.
    - Empty `text` in `Suggestion` raises `ValueError`.
  - Immutability:
    - Assigning to any field raises `dataclasses.FrozenInstanceError`.
- Linting/Formatting:
  - Run `make fmt` then `make lint` to ensure clean style.
- Typing:
  - Run `make typecheck` and ensure no implicit `Any` or ignores are introduced.
- Execution:
  - Run `make test` to validate new unit tests pass alongside existing suite.
