# BL-013D — Command Palette: MRU, Fuzzy Search, Scoped Navigation

Status: Planned  
Owners: Frontend  
Depends on: BL-013B (Top Bar), BL-013C (Editor-only shell)  
Out of scope: Backend search/indexing, autosave/suggestions wiring

## Summary
Now that the Library page is gone (BL-013C), make navigation practical and distraction-free by upgrading the Command Palette to be the single, fast entry point for moving between chapters and basic actions. Add a Recent (MRU) list, fuzzy matching across book/chapter titles, scoped search to the current book, grouped result sections, rich item hints, number shortcuts (1–9), and a palette-triggered “New Chapter” action that uses the current book when available.

## Context
- The Editor is the only page; the palette is the primary navigation surface.
- React Query caches contain books and chapters from prior visits; we can mine them for items.
- We must keep UI minimal: reuse the existing `CommandPalette` and avoid new screens.

## Scope
- Recent (MRU) chapters list stored in localStorage; cap to last 20.
- Fuzzy search across book and chapter titles (lightweight client-side matcher).
- Grouped results: “Recent”, “Navigate”, and “Actions”.
- Scoped search: pressing “/” while the palette is open toggles filtering to current book; Esc or pressing “/” again clears scope.
- Rich item hints: show book title, chapter order `#n`, and last updated date (from cached list types).
- Number shortcuts: keys 1–9 activate corresponding visible result.
- “New Chapter” action: from palette, opens create flow; uses current book if known, otherwise asks to pick a book (via a minimal chooser inline in palette or a follow-up dialog).

Out of scope:
- Server-side search, backend schema changes, or full library views.
- Deep reorder/editor modals beyond existing ones.

## Acceptance Criteria
- Opening the palette (Cmd/Ctrl+K) shows a “Recent” section after the user has opened at least one chapter; most recent first; persisted across reloads.
- Typing in the palette performs fuzzy matching across chapter titles and their parent book titles; matches are highlighted in results.
- Results are grouped: “Recent” (when no query or query is short), “Navigate” (books/chapters), and “Actions”.
- Pressing “/” while the palette is open toggles “Scoped to current book”; the scope indicator is visible; pressing “/” again or Esc clears the scope and updates results.
- Each result item displays: Chapter title, book title, `#order`, and “updated ‹date›” when available.
- Pressing number keys 1–9 while results are visible triggers navigation to the corresponding item; Enter opens the currently highlighted item.
- “New Chapter” action is available in the palette:
  - If a current book context is known, it opens the create chapter dialog pre-bound to that book.
  - If no current book context is known, the user is prompted to select a book (from cached items) before the dialog.
- When caches are empty, the palette triggers a lightweight background hydrate (first page of books and chapters) and updates groups as data arrives.

## Implementation Plan
1. MRU storage
   - Add a small helper: `mru.ts` with `loadMRU()`, `saveMRU()`, `touchMRU(chapterId, meta)`.
   - Update MRU on successful navigation to a chapter (e.g., from `EditorPage` effect or palette run handler).

2. Palette data source
   - In `TopBarProvider` (or `CommandPalette`), derive items from React Query caches:
     - Books: `['books']` pages.
     - Chapters: `['books', bookId, 'chapters']` pages.
   - Fallback: on first open and empty caches, kick off background `listBooks()` and `listBookChapters(bookId)` for the last-known/current book.

3. Fuzzy matcher + highlighting
   - Implement a lightweight, dependency-free matcher (e.g., subsequence + score).
   - Return match ranges for highlighting; apply `<mark>` or styled spans in results.

4. Grouped results + scope
   - Maintain palette state: `query`, `scopeBookId?`, `activeIdx`.
   - Compute groups: Recent (no/short query), Navigate (filtered list), Actions.
   - Toggle scope with “/”; show a small chip in the palette header (“Scoped to Book ‹title›”).

5. Keyboard additions
   - Handle number keys 1–9 to trigger nth visible item.
   - Keep ArrowUp/Down and Enter; maintain existing Escape to close.

6. Actions
   - “New Chapter”: if `scopeBookId` or current editor book id is present, open `ChapterDialog` with that book; else show a mini book picker in the palette list, then open dialog.

7. Copy & A11y
   - Keep palette as `role="dialog"` with labelled `role="searchbox"` and `role="listbox"`.
   - Announce scope changes via Bottom Bar `role="status"` (e.g., “Scoped to Book X”).

8. Dev/test flags
   - No new flags required; keep behavior default in dev/test. Ensure production build has no dev-only mocks.

## Test Plan
- Unit (Vitest + RTL):
  - MRU:
    - After navigating to chapters A, B, A, `loadMRU()` returns [A, B] with A first; persisted across reload (mock localStorage).
  - Fuzzy:
    - Query “port” matches “The Port” and “Portals”; highlight correct ranges; includes book-title matches.
  - Grouping:
    - With no query: MRU shows first; Navigate present; Actions present.
    - With query text: MRU hides when fuzzy results exist; Navigate shows matches; Actions filtered to relevant items (if any).
  - Scope:
    - Press “/” toggles scoped mode; results reduce to current book’s chapters; pressing Esc or “/” clears scope.
  - Shortcuts:
    - Pressing “1” opens first visible result; “2…9” opens corresponding results when available.
    - Enter opens highlighted result.
  - Actions:
    - “New Chapter” with current book opens `ChapterDialog` create mode with that book.
    - Without current book: palette prompts to pick a book; choosing book opens `ChapterDialog`.
  - Cache mining + hydrate:
    - With empty caches, opening palette triggers background fetch (mock endpoints); after resolve, lists update and render results.

- Typecheck:
  - `pnpm run typecheck` passes (no `any` leakage; strict mode).

- Lint/format:
  - `pnpm run lint` and `pnpm run format:check` pass.

## Risks & Mitigations
- Sparse caches lead to empty lists:
  - Mitigate by background hydrate on first open and by always showing Actions.
- Over-eager fuzzy matches clutter results:
  - Tune scoring and minimum query length; prioritize MRU when query is empty/short.
- Keyboard conflicts:
  - Limit number shortcuts to when palette is open and focus is in the dialog; ignore when input elements are focused elsewhere.

## Rollback
- Disable MRU/highlighting/number keys behind minimal guards; keep current palette behavior.
- Remove MRU localStorage reads/writes and scoped filtering code paths.

## References
- Existing palette: `frontend/src/features/topbar/CommandPalette.tsx`
- Top Bar provider & command registration: `frontend/src/features/topbar/context.tsx`
- React Query caches: `frontend/src/features/library/hooks.ts`
- Dialogs: `frontend/src/features/library/components/ChapterDialog.tsx`
