# Ticket BL-011: Suggestions Service — Prompt, Streaming, Accept/Regenerate, Log

## Description
Introduce a Suggestions service that orchestrates AI-generated text suggestions for a chapter. The service composes prompts, streams deltas from the `AIProvider` port, maintains an in-memory suggestions history, and supports “accept” and “regenerate” actions. Upon acceptance, it writes a suggestions log entry under `<book>/.liriac/suggestions/` using atomic writes. Keep business logic in Services; the TUI will integrate later. No network in tests—mock the `AIProvider`.

Scope:
- Service orchestrates streaming via `AIProvider.stream(...)`, yielding deltas as `StreamEvent`s while building the final suggestion text.
- “Regenerate” starts a new streaming session with the same prompt/context and records a new suggestion in history.
- “Accept” merges the selected suggestion into the current chapter text (simple append at the end for this ticket) and writes a timestamped log file to `.liriac/suggestions/`.
- No autosave timer integration in this ticket; return the merged text to the caller. Autosave integration follows later.
- Strict typing across modules; no implicit `Any`.

## Acceptance Criteria
- Source layout (Services):
  - `src/liriac/services/suggestions/` package with:
    - `orchestrator.py`:
      - `class SuggestionsService` with methods:
        - `async def generate(self, *, prompt: str, settings: AISettings, context: ContextProfile | None, ref: ChapterRef) -> AsyncIterator[StreamEvent]`:
          - Calls `AIProvider.stream(...)`.
          - Yields incoming `StreamEvent` deltas to the caller.
          - Accumulates the full text for the current suggestion; records it in history when `done=True`.
        - `def regenerate(self, ref: ChapterRef) -> None`:
          - Prepares internal state to start a new suggestion for the same chapter (history continues).
        - `def get_history(self, ref: ChapterRef) -> tuple[Suggestion, ...]`:
          - Returns immutable tuple of suggestions for a chapter.
        - `def accept(self, *, ref: ChapterRef, base_text: str, index: int) -> str`:
          - Accepts a suggestion by index for the given ref.
          - Returns merged text (append with single blank line + suggestion text).
          - Writes a log entry to `<book>/.liriac/suggestions/YYYY-MM-DDTHH-MM-SSZ-<stem>.md` atomically with UTF-8 + trailing newline.
          - Log content: a small, human-readable Markdown entry (timestamp, source=”ai”, status=”accepted”, and the suggestion text).
      - Type-annotated, side-effect free except for log writes in `accept`.
    - `history.py`:
      - `class SuggestionsHistory`:
        - Holds in-memory `dict[ChapterRef, list[Suggestion]]` with max N suggestions per chapter (configurable, default 10).
        - Methods: `add(ref, suggestion)`, `get(ref) -> tuple[Suggestion, ...]`, `clear(ref)`.
    - `acceptance.py`:
      - `def merge_text(base: str, suggestion: str) -> str`: returns `base` with exactly one blank line separating and a trailing newline.
      - `def write_log(base_dir: Path, ref: ChapterRef, suggestion: Suggestion, now: datetime) -> Path`:
        - Writes a Markdown log file under `<book>/.liriac/suggestions/` with atomic replace.
        - Ensures directories exist; returns final path.
  - `src/liriac/services/suggestions/__init__.py` exports `SuggestionsService`, `SuggestionsHistory`, `merge_text`, `write_log`.

- Domain and Ports:
  - Reuse existing `AIProvider` (domain port) and types (`AISettings`, `StreamEvent`, `ContextProfile`) from `src/liriac/domain`.
  - Reuse `Suggestion` entity (domain) to store finalized suggestions in history.

- Behavior:
  - Streaming: The service yields deltas as they arrive and builds the suggestion text internally; finalizes on `done=True`.
  - History: Stores finalized suggestions per chapter; `get_history` returns a tuple snapshot.
  - Accept: Appends the chosen suggestion to `base_text` using `merge_text` and writes a log file. Service does not write the chapter to disk here.
  - Filesystem writes:
    - Only during `accept` via `write_log`.
    - Atomic write with temp file in the same dir and `os.replace`.
    - UTF-8 encoding; ensure exactly one trailing newline.

- Packaging:
  - No new dependencies; reuse existing ones.

- Typing and Style:
  - Fully annotated; `mypy --strict` passes.
  - `ruff` and `black` pass without changes.

- Developer workflow:
  - `make fmt`, `make lint`, `make typecheck`, `make test` succeed.

## Testing Strategy
- Unit tests under `tests/services/test_suggestions.py`:
  - Import tests:
    - Import `SuggestionsService`, `SuggestionsHistory`, `merge_text`, `write_log`.
  - Streaming and assembly:
    - Use a `FakeAIProvider` that yields two deltas and then `done=True`.
    - Iterate `SuggestionsService.generate(...)`; assert yielded deltas and that history contains a finalized suggestion whose text equals concatenation of deltas.
  - Regenerate:
    - Call `regenerate(ref)` and run another `generate(...)`; assert history length increases.
  - Accept behavior:
    - Provide a `base_text` string and accept suggestion at index 0.
    - Assert returned text equals `merge_text(base_text, suggestion_text)` with exactly one trailing newline.
  - Logging:
    - Call `accept(...)` with a `tmp_path` library; assert a file is created under `<book>/.liriac/suggestions/` with name `YYYY-MM-DDTHH-MM-SSZ-<stem>.md`.
    - Assert file content contains the suggestion text and ends with a newline.
    - Assert no `*.tmp` files remain after write.
  - History window:
    - Configure `SuggestionsHistory` with max size 2; add 3 suggestions; assert only the two most recent remain.
  - Typing and style:
    - Ensure `mypy --strict` passes and no implicit `Any` is introduced.

```