# BL-010 — Frontend DTO Generation from OpenAPI

Status: Implemented  
Owner: Frontend  
Last updated: 2025-09-17  
Epic: OpenAPI & Types

Implementation Notes: Typed fetch wrapper (`api/client.ts`), endpoint helpers (`api/endpoints.ts`), and Vitest unit tests (`client.test.ts`, `endpoints.test.ts`) added. Schema/type regeneration integrated via existing Make targets. Run `make contract-check` to verify no drift.

## Summary
Generate and maintain TypeScript DTOs and client helpers for the frontend using the backend OpenAPI schema. Wire this into developer workflows so DTOs stay in sync and contract drift is caught in CI.

## Context
- Backend serves OpenAPI via DRF Spectacular at `/api/schema/` and writes the schema to `backend/schema.yaml` (Make target: `schema`).
- Frontend uses `openapi-typescript` to output `frontend/src/api/types.ts`.
- The repo already includes:
  - Make targets: `schema`, `fe-typegen`, `contract-check`, `check`.
  - A generated `frontend/src/api/types.ts` stub committed for reference.

This ticket formalizes the end-to-end flow, adds minimal client helpers, and ensures CI gating prevents schema/type drift.

## Scope
- Ensure `backend/schema.yaml` generation is deterministic and included in the `schema` Make target.
- Generate `frontend/src/api/types.ts` via `openapi-typescript` with pinned CLI version (via `pnpm dlx` in Makefile).
- Provide a thin, typed fetch wrapper and endpoint-specific helpers (books, chapters, personas, health).
- Add tests for the helpers (type-level and runtime smoke).
- Integrate drift detection into `check` and `contract-check` flows (already scaffolded), and document usage.

Out of scope:
- Full API client generations or runtime validation scaffolding.
- Changes to backend endpoints beyond ensuring schema generation.

## Acceptance Criteria
- Running `make schema fe-typegen` updates `backend/schema.yaml` and `frontend/src/api/types.ts` without errors.
- `make contract-check` passes with no local changes; fails when there is drift.
- Frontend exposes a typed API client module:
  - `api/client.ts`: base fetch with JSON parsing, error handling (`Response` -> `{ok,data,error}`).
  - `api/endpoints.ts`: minimal helpers:
    - `listBooks(params?)`
    - `getBook(id)`
    - `listBookChapters(bookId, params?)`
    - `getChapter(id)`
    - `autosaveChapter(id, payload)`
    - `listPersonas(params?)`
    - `createPersona(payload)`
    - `health()`
- Helpers are typed against generated DTOs from `types.ts` and compile under `tsc --noEmit`.
- Vitest unit tests cover:
  - Happy-path JSON decode and typing for one list endpoint.
  - Error-path handling (non-2xx -> object with error).
- `make fe-test` and `make check` succeed locally.

## Implementation Plan
1. Verify/pin `openapi-typescript` version via `pnpm dlx` in Makefile (already configured).
2. Ensure `schema` target runs `manage.py spectacular --file schema.yaml` deterministically (already configured).
3. Add `frontend/src/api/client.ts`:
   - `request<T>(input: RequestInfo, init?: RequestInit): Promise<{ ok: true; data: T } | { ok: false; error: string; status: number }>`
   - Base URL from `import.meta.env.VITE_API_BASE` with default `/`.
4. Add `frontend/src/api/endpoints.ts`:
   - Functions mapping to MVP endpoints and using `types.ts` for input/output typing.
5. Add tests:
   - `frontend/src/api/client.test.ts` — mock `fetch` for success and error cases.
   - `frontend/src/api/endpoints.test.ts` — smoke test for one helper using mocked `fetch`.
6. Update docs:
   - Document regeneration flow in this ticket and cross-link Make targets.
7. Validate:
   - Run `make schema fe-typegen`.
   - Run `make contract-check`.
   - Run `make fe-typecheck fe-test`.

## Test Plan
- Unit tests (Vitest):
  - Client wrapper:
    - 200 returns `{ ok: true, data }`.
    - 400/500 returns `{ ok: false, error, status }`.
  - Endpoint helper:
    - `listBooks()` returns parsed, typed data.
- Typecheck:
  - `pnpm run typecheck` passes with no `any` leakage from API shapes.
- Contract checks:
  - `make contract-check` passes; manual schema tweak causes failure (expected).

## Developer Workflow
- Regenerate schema and types after backend changes:
  - `make schema fe-typegen`
- Validate contracts:
  - `make contract-check`
- Full local gate:
  - `make check`

## Risks & Mitigations
- Risk: Schema drift breaks frontend silently.
  - Mitigation: `contract-check` and `check` enforce no drift.
- Risk: Non-deterministic schema ordering.
  - Mitigation: Use DRF Spectacular defaults; avoid dynamic titles/descriptions in code.
- Risk: Runtime mismatch (backend running with schema from older commit).
  - Mitigation: Local dev cadence: re-run `make schema fe-typegen` on backend changes.

## Affected Files
- backend/schema.yaml (generated)
- frontend/src/api/types.ts (generated)
- frontend/src/api/client.ts (new)
- frontend/src/api/endpoints.ts (new)
- frontend/src/api/*.test.ts (new)

## Rollback
- Revert changes to `client.ts`/`endpoints.ts`.
- Regenerate `types.ts` from a known-good `schema.yaml`.

## References
- Makefile targets: `schema`, `fe-typegen`, `contract-check`, `check`
- DRF Spectacular: https://drf-spectacular.readthedocs.io/
- openapi-typescript: https://github.com/drwpow/openapi-typescript