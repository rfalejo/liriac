# Ticket BL-010: OpenAI‑Compatible AI Streaming Provider

## Description
Introduce an asynchronous AI provider that streams text deltas from an OpenAI‑compatible Chat Completions endpoint over HTTP. The provider lives under Infra, implements a typed Domain `Protocol`, handles timeouts, a single retry with short backoff on transient failures, clean cancellation, and maps wire events into a strict, testable event type.

Scope:
- Define a Domain port for AI streaming with strict typing and no IO in the Domain layer.
- Implement an Infra adapter using `httpx` async streaming against an OpenAI‑compatible API.
- Map streamed chunks to a unified `StreamEvent` type with end‑of‑stream sentinel and optional token usage metadata.
- Respect existing configuration adapter for API key, model, base URL, and request timeout.
- Offline tests only; use `respx` to mock HTTP.

Out of scope:
- UI integration beyond importability (TUI will consume later).
- Prompt composition and domain context building (later tickets).
- Budgeting, advanced backoff, or multi‑retry strategies.

## Acceptance Criteria
- Domain Ports and Types:
  - `src/liriac/domain/ports.py`:
    - Adds `class AIProvider(Protocol)` with:
      - `async def stream(self, *, prompt: str, settings: AISettings, context: ContextProfile | None = None) -> AsyncIterator[StreamEvent]]: ...`
    - Docstrings clarify contract: async iterator yields deltas; final event marks `done=True`; no network or IO in Domain itself.
  - `src/liriac/domain/types.py` (or new `src/liriac/domain/events.py` if preferred):
    - Defines `TypedDict`/`dataclass` types:
      - `AISettings`: minimal fields for now: `model: str`, `temperature: float | None`, `max_tokens: int | None`.
      - `Tokens`: `prompt: int | None`, `completion: int | None`, `total: int | None`.
      - `StreamEvent`: `delta: str | None`, `usage: Tokens | None`, `done: bool`, `error: str | None`.
    - All types are fully annotated and exported via `__all__`. No implicit `Any`.

- Infra Implementation (OpenAI client):
  - New package layout:
    - `src/liriac/infra/ai/__init__.py` (exports `OpenAIProvider`).
    - `src/liriac/infra/ai/openai/client.py` implements `class OpenAIProvider(AIProvider)`.
  - Behavior:
    - Uses `httpx.AsyncClient` with timeout from settings; base URL from settings or default `https://api.openai.com/v1`.
    - Auth header `Authorization: Bearer <OPENAI_API_KEY>`; JSON body for Chat Completions with `stream=true`.
    - Streaming:
      - Parses SSE/line‑delimited JSON chunks (`data: ...`) until `[DONE]`.
      - Emits `StreamEvent` with `delta` text fragments as they arrive.
      - At stream end, emits a final `StreamEvent(done=True, delta=None)`; if usage is present in final payload, include it.
    - Cancellation: supports external cancellation via `anyio.move_on_after` around the request with timeout from settings.
    - Retry: on a single transient error (HTTP 5xx or network error), performs one retry with a short backoff (e.g., 0.25–0.5s).
    - Error mapping: on non‑retryable errors (HTTP 4xx, auth), emit a terminal event with `error=str(...)` or raise a concise `ValueError` that tests assert.
    - No global state; client instances close cleanly.

- Configuration:
  - Uses existing `AppSettings` fields from `src/liriac/infra/config/settings.py`:
    - `openai_api_key`, `openai_model`, `openai_base_url`, `openai_request_timeout`, `openai_max_tokens`.
  - Provider accepts explicit `AISettings` at call time; when a field is `None`, falls back to `AppSettings` defaults where applicable (e.g., `model`, `max_tokens`).

- Packaging:
  - `pyproject.toml` updates:
    - Add runtime dependency: `httpx>=0.25` and `anyio>=4`.
  - Dev/test dependencies:
    - Add `respx>=0.20` under `[project.optional-dependencies].dev` for HTTP mocking (if not already present).

- Tests:
  - `tests/infra/ai/test_openai_provider.py` (pytest + pytest‑asyncio + respx):
    - Import test: `from liriac.infra.ai.openai.client import OpenAIProvider` succeeds.
    - Happy path streaming:
      - Mocks a streamed response with two content deltas and a final `[DONE]`.
      - Asserts the async iterator yields `StreamEvent` with expected `delta`s and final `done=True`.
    - Usage mapping:
      - Mocks a final chunk containing `usage` and verifies it’s exposed under `event.usage`.
    - Retry on transient failure:
      - First response 502, second success; verify exactly one retry and successful streaming of deltas.
    - Timeout/cancellation:
      - Simulates a hanging stream and asserts graceful cancellation occurs within the configured timeout without crashing tests.
    - Error handling:
      - 401 Unauthorized → maps to terminal error (event with `error` or raised `ValueError`); test asserts a clean, concise message.
  - No real network calls; all HTTP interactions mocked.

- Typing and Style:
  - Code is fully annotated; `mypy --strict` passes.
  - `ruff` and `black` pass with no changes after initial format.
  - No `print`; optional structured logging via existing JSON logger is acceptable but not required.

## Testing Strategy
- Async streaming tests:
  - Use `respx.mock(assert_all_called=True)` to register a POST route to `<base_url>/chat/completions` returning a mocked streaming response.
  - Provide an iterator of byte lines representing SSE:
    - `b"data: {\"choices\":[{\"delta\":{\"content\":\"Hello\"}}]}\n\n"`
    - `b"data: {\"choices\":[{\"delta\":{\"content\":\" world\"}}]}\n\n"`
    - `b"data: [DONE]\n\n"`
  - Iterate `async for event in provider.stream(...):` and collect deltas; assert final `done=True`.
- Usage tests:
  - Include a final JSON chunk with `"usage": {"prompt_tokens": 10, "completion_tokens": 5, "total_tokens": 15}`; verify mapped to `Tokens`.
- Retry tests:
  - Configure respx to return 502 on first call, then a valid streaming response; assert two calls were made and output is correct.
- Timeout/cancellation:
  - Use `anyio.fail_after(0.1)` or provider’s timeout to ensure test completes; assert that no unhandled exception escapes and the iterator terminates promptly.
- Error mapping:
  - Mock 401/400 responses and assert raised `ValueError` or terminal error events with concise messages.
- Quality gates:
  - Run `make fmt`, `make lint`, `make typecheck`, and `make test`; ensure all pass without network access.
